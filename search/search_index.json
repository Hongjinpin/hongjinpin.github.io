{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u9996\u9875","text":"<p>Tip</p> <p>\u4ec5\u8bb0\u5f55\u65e5\u5e38\u5404\u7c7b\u5c0f\u7b14\u8bb0</p>"},{"location":"common/certbot/","title":"certbot \u4f7f\u7528\u4ecb\u7ecd","text":"<p>\u539f\u6587\u5730\u5740\uff1ahttps://www.seanzhao.me/2018/06/21/certbot-manual.html</p>"},{"location":"common/certbot/#_1","title":"\u4ecb\u7ecd","text":"<p>certbot\u662f\u4e13\u95e8\u4e3aLet\u2019s encrypt\u5236\u4f5c\u7684\u4e00\u4e2a\u7ba1\u7406\u8bc1\u4e66\u5de5\u5177\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b83\u6765\u751f\u6210\u8bc1\u4e66\u7ba1\u7406\u66f4\u65b0Let\u2019s encrypt\u8bc1\u4e66\u3002<code>\u5b83\u4eec\u90fd\u662f\u514d\u8d39\u7684\u3002</code>\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u9700\u8981\u5728\u670d\u52a1\u5668\u4e0a\u9762\u6709root\u6743\u9650\u624d\u53ef\u4ee5\u5141\u8bb8certbot\u7ba1\u7406\u8bc1\u4e66\u3002</p>"},{"location":"common/certbot/#_2","title":"\u5b89\u88c5","text":"<p>\u76f4\u63a5\u8bbf\u95eecertbot.eff.org\u7684\u9996\u9875\u9009\u62e9\u670d\u52a1\u5668\u73af\u5883\u548c\u7cfb\u7edf\u5c31\u53ef\u4ee5\u663e\u793a\u51fa\u5b89\u88c5\u8bf4\u660e</p>"},{"location":"common/certbot/#_3","title":"\u7cfb\u7edf\u8981\u6c42","text":"<p>Certbot\u76ee\u524d\u9700\u8981\u5728\u50cfUNIX\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u8fd0\u884cPython 2.7\u62163.4+\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5b83\u9700\u8981\u4ee5\u5199root\u8bbf\u95ee\u6743\u9650 <code>/etc/letsencrypt</code>\uff0c<code>/var/log/letsencrypt</code>\uff0c<code>/var/lib/letsencrypt</code>\uff0c\u7ed1\u5b9a\u5230\u7aef\u53e380\u548c443\uff08\u5982\u679c\u60a8\u4f7f\u7528\u7684standalone\u63d2\u4ef6\uff09\uff0c\u5e76\u8bfb\u53d6\u548c\u4fee\u6539Web\u670d\u52a1\u5668\u914d\u7f6e\uff08\u5982\u679c\u4f7f\u7528apache\u6216nginx \u63d2\u4ef6\uff09\u3002\u5982\u679c\u8fd9\u4e9b\u90fd\u4e0d\u9002\u7528\u4e8e\u60a8\uff0c\u7406\u8bba\u4e0a\u53ef\u4ee5\u5728\u6ca1\u6709root\u6743\u9650\u7684\u60c5\u51b5\u4e0b\u8fd0\u884c\uff0c\u4f46\u5bf9\u4e8e\u5927\u591a\u6570\u5e0c\u671b\u907f\u514d\u4ee5root\u8eab\u4efd\u8fd0\u884cACME\u5ba2\u6237\u7aef\u7684\u7528\u6237\uff0cletsencrypt-nosudo\u6216simp_le\u662f\u66f4\u5408\u9002\u7684\u9009\u62e9\u3002</p>"},{"location":"common/certbot/#_4","title":"\u79bb\u7ebf\u5b89\u88c5","text":"<pre><code>user @ webserver\uff1a\u301c$ wget https://dl.eff.org/certbot-auto\nuser @ webserver\uff1a\u301c$ chmod a + x ./certbot-auto\nuser @ webserver\uff1a\u301c$ ./certbot-auto --help\n</code></pre> <p>\u5728\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u60a8\u53ef\u4ee5\u8fd0\u884c<code>certbot-auto</code>\u6216\u8005<code>certbot</code>\uff0c\u5ba2\u6237\u7aef\u5c06\u5f15\u5bfc\u60a8\u5b8c\u6210\u4ea4\u4e92\u5f0f\u83b7\u53d6\u548c\u5b89\u88c5\u8bc1\u4e66\u7684\u8fc7\u7a0b\u3002</p> <p>\u5982\u679c\u9700\u8981\u5e2e\u52a9\u53ef\u4ee5\u8f93\u5165 <code>./certbot-auto --help all</code> \u60a8\u8fd8\u53ef\u4ee5\u4ece\u547d\u4ee4\u884c\u51c6\u786e\u5730\u544a\u8bc9\u5b83\u8981\u505a\u4ec0\u4e48\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u60f3\u83b7\u5f97example.com\u3001www.example.com\u548cother.example.net\u7684\u8bc1\u4e66\uff0c\u53ef\u4ee5\u4f7f\u7528Apache\u63d2\u4ef6\u83b7\u53d6\u548c\u5b89\u88c5\u8bc1\u4e66\uff0c\u60a8\u53ef\u4ee5\u8fd9\u6837\u505a:</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u60f3\u8981\u83b7\u5f97example.com\u3001www.example.com \u548c other.example.net\u7684\u8bc1\u4e66\uff0c\u4f7f\u7528certbot\u81ea\u5e26\u7684apache\u5de5\u5177\u83b7\u53d6\u548c\u5b89\u88c5\uff1a <code>certbot --apache -d example.com -d www.example.com -d other.example.net</code> \u5982\u679c\u7b2c\u4e00\u6b21\u5141\u8bb8\u8be5\u547d\u4ee4\uff0c\u5c06\u4f1a\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u8981\u6c42\u8f93\u5165\u90ae\u7bb1\u7b49\u4fe1\u606f\u3002\u8be5\u547d\u4ee4\u4f1a\u81ea\u52a8\u67e5\u627eapache\u7684\u914d\u7f6e\u6587\u4ef6\u5e76\u4e14\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u652f\u6301https\u3002</p> <p>\u5982\u679c\u60f3\u8981\u6536\u5230\u914d\u7f6eapache\u8bbe\u7f6e\u53ef\u4ee5\u4f7f\u7528<code>certonly</code>\u5b50\u547d\u4ee4 <code>sudo certbot --apache certonly</code></p> <p>\u6ce8\u610f\uff1a\u5177\u6709certonly\u7684apache\u63d2\u4ef6\u4f1a\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c</p> <ol> <li>\u8fdb\u884c\u4e34\u65f6\u914d\u7f6e\u66f4\u6539</li> <li>\u6267\u884c\u91cd\u65b0\u52a0\u8f7d</li> <li>\u6062\u590d\u6240\u6709\u66f4\u6539</li> <li>\u6267\u884c\u53e6\u4e00\u4e2a\u91cd\u65b0\u52a0\u8f7d \u8fd9\u4f3c\u4e4e\u662f\u4e00\u4e2a\u53ef\u9760\u7684\u8fc7\u7a0b\uff0c\u4f46\u662f\u5982\u679c\u60a8\u4e0d\u5e0c\u671bCertbot\u4ee5\u4efb\u4f55\u65b9\u5f0f\u89e6\u6478\u60a8\u7684Apache\u8fdb\u7a0b\u6216\u6587\u4ef6\uff0c\u5219\u53ef\u4ee5\u6539\u4e3a\u4f7f\u7528 webroot\u63d2\u4ef6\u3002</li> </ol>"},{"location":"common/certbot/#_5","title":"\u547d\u4ee4\u4ecb\u7ecd","text":"<p>\u63d0\u793a\uff1a\u5982\u679c\u60a8\u7684\u7cfb\u7edf\u4f7f\u7528\u8f83\u65e7\u7684\u8f6f\u4ef6\u5305\uff0c\u6216\u8005\u60a8\u4f7f\u7528\u4e86\u5907\u7528\u5b89\u88c5\u65b9\u6cd5\uff0c\u5219certbotWeb\u670d\u52a1\u5668\u4e0a\u7684\u811a\u672c\u53ef\u80fd\u4f1a\u88ab\u547d\u540d\u3002\u5728\u6574\u4e2a\u6587\u6863\u4e2d\uff0c\u53ea\u8981\u4f60\u770b\u5230\uff0c\u6839\u636e\u9700\u8981\u4ea4\u6362\u6b63\u786e\u7684\u540d\u79f0\u3002<code>letsencrypt``certbot-auto``certbot</code></p> Plugin Auth Inst \u63cf\u8ff0 \u7c7b\u578b\u548c\u7aef\u53e3challenge\\-type apache y y \u4f7f\u7528Apache\u81ea\u52a8\u83b7\u53d6\u548c\u5b89\u88c5\u8bc1\u4e662.4\u57281.0\u4ee5\u4e0a\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0alibaugeas0\u3002 tls-sni-01\uff08443\uff09 webroot y n \u8fc7\u5199\u5165\u5230webroot\u76ee\u5f55\u83b7\u5f97\u8bc1\u4e66\u4e2a\u5df2\u7ecf\u8fd0\u884c\u7684web\u670d\u52a1\u5668\u3002 http-01\uff0880\uff09 nginx y y \u4f7f\u7528Nginx\u81ea\u52a8\u83b7\u53d6\u548c\u5b89\u88c5\u8bc1\u4e66\u3002\u7528Certbot 0.9.0\u53d1\u8d27\u3002 tls-sni-01\uff08443\uff09 standalone y n \u7528\u201c\u72ec\u7acb\u201d\u7f51\u7edc\u670d\u52a1\u5668\u83b7\u53d6\u8bc1\u4e66\u3002\u6c42\u7aef\u53e380\u6216443\u53ef\u7528\u3002\u8fd9\u5f88\u6709\u7528\u6709\u7f51\u7edc\u670d\u52a1\u5668\u7684\u7cfb\u7edf\uff0c\u6216\u76f4\u63a5\u4e0e\u7cfb\u7edf\u96c6\u6210\u5730\u7f51\u7edc\u670d\u52a1\u5668\u4e0d\u53d7\u652f\u6301\u6216\u4e0d\u53d7\u6b22\u8fce\u3002 http-01\uff0880\uff09\u6216 tls-sni-01\uff08443\uff09 DNS plugins y n \u7c7b\u63d2\u4ef6\u53ef\u4ee5\u901a\u8fc7\u81ea\u52a8\u83b7\u53d6\u8bc1\u4e66\u6539DNS\u8bb0\u5f55\u4ee5\u8bc1\u660e\u60a8\u6709\u63a7\u5236\u6743\u3002\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u8fdb\u884c\u57df\u9a8c\u8bc1\u662fLet's\u83b7\u5f97\u901a\u914d\u7b26\u8bc1\u4e66\u7684\u552f\u4e00\u65b9\u6cd5\u5bc6\u3002 dns-01\uff0853\uff09 manual y n \u8fc7\u5411\u60a8\u63d0\u4f9b\u8bf4\u660e\u5e2e\u52a9\u60a8\u83b7\u5f97\u8bc1\u4e66\u5df1\u6267\u884c\u57df\u9a8c\u8bc1\u3002\u53e6\u5916\u5141\u8bb8\u4f60\u5b9a\u811a\u672c\u4ee5\u81ea\u52a8\u6267\u884ca\u4e2d\u7684\u9a8c\u8bc1\u4efb\u52a1\u5236\u7684\u65b9\u5f0f\u3002 http-01\uff0880\uff09\uff0c dns-01\uff0853\uff09\u6216 tls-sni-01\uff08443\uff09 <p>\u63d2\u4ef6\u4f7f\u7528\u51e0\u79cdACME\u534f\u8bae\u9a8c\u8bc1\u4f60\u662f\u5426\u6709\u8be5\u57df\u540d\u7684\u6240\u6709\u6743\u3002\u9009\u9879\u662fhttp-01\uff08\u4f7f\u7528\u7aef\u53e380\uff09\uff0c tls-sni-01\uff08\u7aef\u53e3443\uff09\u548cdns-01\uff08\u9700\u8981\u5728\u7aef\u53e353\u4e0a\u914d\u7f6eDNS\u670d\u52a1\u5668\uff0c\u5c3d\u7ba1\u8fd9\u901a\u5e38\u4e0eWeb\u670d\u52a1\u5668\u4e0d\u540c\uff09\u3002\u5c11\u6570\u63d2\u4ef6\u652f\u6301\u591a\u79cd\u9a8c\u8bc1\u7c7b\u578b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u60a8\u53ef\u4ee5\u9009\u62e9\u4e00\u79cd<code>--preferred-challenges</code>\u3002</p> <p>\u4e5f\u6709\u8bb8\u591a\u7b2c\u4e09\u65b9\u63d2\u4ef6\u53ef\u7528\u3002\u4e0b\u9762\u6211\u4eec\u66f4\u8be6\u7ec6\u5730\u63cf\u8ff0\u6bcf\u4e2a\u63d2\u4ef6\u5982\u4f55\u4f7f\u7528\u4ee5\u53ca\u4f7f\u7528\u60c5\u51b5\u3002</p>"},{"location":"common/certbot/#apache","title":"apache","text":"<p>Apache\u63d2\u4ef6\u76ee\u524d\u9700\u8981\u5b89\u88c5\u6709augeas 1.0\u7248\u7684\u64cd\u4f5c\u7cfb\u7edf; \u76ee\u524d\u5b83\u652f\u6301 \u57fa\u4e8eDebian\uff0cFedora\uff0cSUSE\uff0cGentoo\u548cDarwin\u7684\u73b0\u4ee3\u64cd\u4f5c\u7cfb\u7edf\u3002\u8fd9\u53ef\u4ee5\u5728Apache Web\u670d\u52a1\u5668\u4e0a\u81ea\u52a8\u83b7\u53d6\u548c\u5b89\u88c5\u8bc1\u4e66\u3002\u8981\u5728\u547d\u4ee4\u884c\u4e0a\u6307\u5b9a\u4f7f\u7528\u6b64\u63d2\u4ef6\uff0c\u53ea\u9700\u6307\u5b9a <code>--apache</code>\u5982<code>certbot --apache</code>\u3002</p>"},{"location":"common/certbot/#webroot","title":"Webroot","text":"<p>\u5982\u679c\u4f60\u7684\u670d\u52a1\u5668\u6b63\u5728\u8fd0\u884c\uff0c\u800c\u60a8\u5fc5\u987b\u4fee\u6539\u914d\u7f6e\uff0c\u4f60\u4e0d\u5e0c\u671b\u5728\u5236\u4f5c\u8bc1\u4e66\u8fc7\u7a0b\u4e2d\u505c\u6b62Web\u670d\u52a1\u5668\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528Web\u6839\u76ee\u5f55\u63d2\u4ef6\u901a\u8fc7\u5305\u62ec\u83b7\u53d6\u8bc1\u4e66<code>certonly</code>\u548c<code>--webroot</code>\u5728\u547d\u4ee4\u884c\u4e0a\u3002\u5e76\u4e14\u9700\u8981\u6307\u5b9a<code>--webroot-path</code> \u6216<code>-w</code>\u53c2\u6570\u5305\u542b\u7f51\u7ad9\u7684\u6839\u76ee\u5f55\u3002\u4f8b\u5982\uff0c \u6216\u8005\u662f\u4e24\u4e2a\u5e38\u89c1\u7684webroot\u8def\u5f84\u3002<code>--webroot-path /var/www/html``--webroot-path /usr/share/nginx/html</code> \u793a\u4f8b\uff1a <code>certbot certonly --webroot -w /var/www/example -d www.example.com -d example.com -w /var/www/other -d other.example.net -d another.other.example.net</code> \u524d\u9762\u4e24\u4e2a\u57df\u540d\u4f7f\u7528<code>/var/www/example</code>\u76ee\u5f55\u540e\u9762\u4e24\u4e2a\u57df\u540d\u4f7f\u7528<code>/var/www/other</code>\u76ee\u5f55</p> <p>webroot\u5de5\u4f5c\u7684\u539f\u7406\u5c31\u662f\u5728\u6bcf\u4e2a\u7f51\u7ad9\u6839\u76ee\u5f55\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6<code>${webroot-path}/.well-known/acme-challenge</code>\uff0c\u7136\u540eLet\u2019s encrypt\u670d\u52a1\u5668\u4f7f\u7528HTTP\u8bf7\u6c42\u9a8c\u8bc1\u3002\u7c7b\u4f3cgoogle\u3001\u767e\u5ea6\u7684\u7ad9\u957f\u9a8c\u8bc1\u4e00\u6837</p>"},{"location":"common/certbot/#nginx","title":"nginx","text":"<p>\u6211\u4eec\u5efa\u8bae\u5728\u4f7f\u7528\u4e4b\u524d\u5907\u4efdNginx\u914d\u7f6e\uff08\u5c3d\u7ba1\u60a8\u4e5f\u53ef\u4ee5\u5c06\u914d\u7f6e\u6062\u590d\u4e3a\u914d\u7f6e\uff09\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7\u5728\u547d\u4ee4\u884c\u4e0a\u63d0\u4f9b\u6807\u5fd7\u6765\u4f7f\u7528\u5b83\u3002<code>certbot --nginx rollback--nginx</code> <code>certbot --nginx</code></p>"},{"location":"common/certbot/#standalone","title":"Standalone","text":"<p>\u5982\u679c\u60a8\u4e0d\u60f3\u4f7f\u7528\uff08\u6216\u5f53\u524d\u6ca1\u6709\uff09\u73b0\u6709\u670d\u52a1\u5668\u8f6f\u4ef6\uff0c\u8bf7\u4f7f\u7528\u72ec\u7acb\u6a21\u5f0f\u83b7\u53d6\u8bc1\u4e66\u3002\u72ec\u7acb\u6a21\u5f0f\u4e0d\u4f9d\u8d56\u83b7\u53d6\u8bc1\u4e66\u7684\u670d\u52a1\u5668\u548c\u670d\u52a1\u5668\u8f6f\u4ef6\u3002 \u5982\u679c\u4f7f\u7528<code>Standalone</code>\u6765\u83b7\u5f97\u8bc1\u4e66\u9700\u8981\u52a0\u4e0a<code>certonly</code>\u548c<code>--standalone</code>\u5e76\u4e14<code>80\u7aef\u53e3</code>\u6216\u8005<code>443\u7aef\u53e3</code>\u6240\u6709\u8fd9\u4e24\u4e2a\u7aef\u53e3\u5fc5\u987b\u6709\u4e00\u4e2a\u662f\u7a7a\u95f2\u53ef\u5360\u7528\u7684\u624d\u884c\u3002</p> <p>\u5982\u679c\u8981\u6307\u5b9a\u4f7f\u7528\u90a3\u4e00\u4e2a\u7aef\u53e3\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\uff1a <code>--preferred-challenges http</code> \u4f7f\u7528\u7aef\u53e380 <code>--preferred-challenges tls-sni</code> \u4f7f\u7528\u7aef\u53e3443</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cCertbot\u9996\u5148\u5c1d\u8bd5\u7ed1\u5b9a\u5230IPv6\u7684\u7aef\u53e3\uff0c\u7136\u540e\u7ed1\u5b9a\u5230IPv4\u8be5\u7aef\u53e3; \u53ea\u8981\u81f3\u5c11\u6709\u4e00\u4e2a\u7ed1\u5b9a\u6210\u529f\uff0cCertbot\u5c31\u4f1a\u7ee7\u7eed\u3002\u5728\u5927\u591a\u6570Linux\u7cfb\u7edf\u4e0a\uff0cIPv4\u6d41\u91cf\u5c06\u88ab\u8def\u7531\u91cd\u5b9a\u5411\u5230IPv6\u7aef\u53e3\uff0c\u5e76\u4e14\u671f\u671b\u5728\u7b2c\u4e8c\u6b21\u7ed1\u5b9a\u671f\u95f4\u51fa\u73b0\u6545\u969c\u3002 \u4f7f\u7528<code>--&lt;challenge-type&gt;-address</code>\u660e\u786e\u5730\u544a\u8bc9Certbot\u63a5\u53e3\uff08\u548c\u534f\u8bae\uff09\u3002</p>"},{"location":"common/certbot/#dns_plugins","title":"DNS Plugins","text":"<p>\u5982\u679c\u60a8\u5e0c\u671b\u4eceLet\u2019s Encrypt\u83b7\u53d6\u901a\u914d\u7b26\u8bc1\u4e66\u6216certbot\u5728\u9664\u76ee\u6807Web\u670d\u52a1\u5668\u4e4b\u5916\u7684\u8ba1\u7b97\u673a\u4e0a\u8fd0\u884c \uff0c\u5219\u53ef\u4ee5\u4f7f\u7528Certbot\u7684\u4e00\u4e2aDNS\u63d2\u4ef6\u3002</p> <p>\u8fd9\u4e9b\u63d2\u4ef6\u4ecd\u5904\u4e8e\u88ab\u8bb8\u591a\u53d1\u884c\u7248\u6253\u5305\u7684\u8fc7\u7a0b\u4e2d\uff0c\u76ee\u524d\u65e0\u6cd5\u5b89\u88c5certbot-auto\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u613f\u610f\u81ea\u5df1\u5b89\u88c5\u8bc1\u4e66\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528Docker\u8fd0\u884c\u8fd9\u4e9b\u63d2\u4ef6\u3002</p> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u60a8\u53ef\u4ee5\u5728\u4ee5\u4e0b\u7f51\u5740\u627e\u5230\u6709\u5173\u5982\u4f55\u4f7f\u7528\u6bcf\u4e2a\u63d2\u4ef6\u7684\u6587\u6863\uff1a</p> <p>certbot-DNS-cloudflare</p> <p>certbot-DNS-cloudxns</p> <p>certbot-DNS-digitalocean</p> <p>certbot-DNS-dnsimple</p> <p>certbot-DNS-dnsmadeeasy</p> <p>certbot-DNS-google</p> <p>certbot-dns-luadns</p> <p>certbot-dns-nsone</p> <p>certbot-dns-rfc2136</p> <p>certbot-dns-route53</p>"},{"location":"common/certbot/#manual","title":"Manual","text":"<p>\u5982\u679c\u9700\u8981\u83b7\u5f97\u5728\u76ee\u6807\u670d\u52a1\u5668\u4e4b\u5916\u5141\u8bb8\u7684\u8bc1\u4e66\u6216\u8005\u81ea\u5df1\u6267\u884c\u9a8c\u8bc1\u6b65\u9aa4\u5219\u53ef\u4ee5\u4f7f\u7528\u624b\u52a8\u63d2\u4ef6<code>Manual</code>\u901a\u8fc7\u6307\u5b9a<code>certonly</code>\u548c<code>--manual</code>\u83b7\u53d6\u8bc1\u4e66\u3002</p> <p>Manual\u9a8c\u8bc1\u53ef\u4ee5\u4f7f\u7528<code>http</code>,<code>dns</code>\u6216\u8005<code>tls-sni</code>\u9a8c\u8bc1\u3002\u53ef\u4ee5\u4f7f\u7528\u8be5<code>--preferred-challenges</code>\u9009\u9879\u6765\u9009\u62e9\u9a8c\u8bc1\u65b9\u5f0f\u3002 \u8be5<code>http</code>\u9a8c\u8bc1\u8981\u6c42\u60a8\u5728\u7f51\u7ad9\u7684\u6839\u76ee\u5f55\u653e\u7f6e\u5728\u4e00\u4e2a\u7279\u5b9a\u7684\u540d\u79f0\u548c\u5177\u4f53\u5185\u5bb9\u7684\u6587\u4ef6<code>/.well-known/acme-challenge/</code>\u3002\u672c\u8d28\u4e0a\u5b83\u4e0e<code>webroot</code>\u63d2\u4ef6\u76f8\u540c\uff0c\u4f46\u4e0d\u662f\u81ea\u52a8\u7684\u3002</p> <p>\u4f7f\u7528<code>dns</code>\u9a8c\u8bc1\u65f6\uff0c<code>certbot</code>\u9700\u8981\u5728\u9881\u53d1\u8bc1\u4e66\u7684\u57df\u540d\u7684DNS\u4e0a\u9762\u6dfb\u52a0\u4e00\u6761TXT\u8bb0\u5f55\uff0c\u524d\u7f00\u4e3a<code>_acme-challenge</code>\u3002</p> <p>\u4f8b\u5982\uff1a\u57df\u540d\u4e3a<code>example.com</code></p> <p>TXT\u8bb0\u5f55\u4e3a<code>_acme-challenge.example.com. 300 IN TXT \"gfj9Xq...Rg85nM\"</code></p> <p>\u4f7f\u7528<code>tls-sni</code>\u9a8c\u8bc1\u65f6\uff0ccertbot\u5c06\u4e3a\u60a8\u51c6\u5907\u4e00\u4efd\u81ea\u7b7e\u540d\u7684SSL\u8bc1\u4e66\uff0c\u5e76\u5c06\u68c0\u6d4b\u7684\u9a8c\u8bc1\u7f16\u7801\u5230<code>subjectAlternatNames</code>\u6761\u76ee\u4e2d\u3002\u60a8\u5c06\u9700\u8981\u914d\u7f6e\u60a8\u7684SSL\u670d\u52a1\u5668\u4ee5\u4f7f\u7528SNI\u5c06\u6b64\u9a8c\u8bc1SSL\u8bc1\u4e66\u5448\u73b0\u7ed9ACME\u670d\u52a1\u5668\u3002</p>"},{"location":"common/certbot/#_6","title":"\u7ed3\u5408\u63d2\u4ef6\u4f7f\u7528","text":"<p>\u6709\u65f6\u60a8\u53ef\u80fd\u60f3\u8981\u6307\u5b9a\u4e0d\u540c\u7684\u9a8c\u8bc1\u65b9\u5f0f\u548c\u5b89\u88c5\u7a0b\u5e8f\u63d2\u4ef6\u7684\u7ec4\u5408\u3002\u8981\u505a\u5230\u8fd9\u4e00\u70b9\uff0c\u8bf4\u660e\u4e0e\u8ba4\u8bc1\u63d2\u4ef6 <code>--authenticator</code>\u6216<code>-a</code>\u4e0e\u5b89\u88c5\u63d2\u4ef6<code>--installer</code>\u6216 <code>-i</code>\u3002</p> <p>\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528<code>webroot</code>\u63d2\u4ef6\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u5e76\u4f7f\u7528<code>apache</code>\u63d2\u4ef6\u6765\u5b89\u88c5\u8bc1\u4e66\uff0c\u8fd9\u53ef\u80fd\u662f\u56e0\u4e3a\u60a8\u4f7f\u7528\u4ee3\u7406\u6216CDN\u8fdb\u884cSSL\uff0c\u5e76\u4e14\u53ea\u60f3\u786e\u4fdd\u5b83\u4eec\u4e0e\u539f\u59cb\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u8fde\u63a5\u4e0d\u80fd\u4f7f\u7528\u7531\u4e8e\u4e2d\u95f4\u4ee3\u7406\u7684tls-sni-01\u9a8c\u8bc1\u3002 <code>certbot run -a webroot -i apache -w /var/www/html -d example.com</code></p>"},{"location":"common/certbot/#_7","title":"\u7ba1\u7406\u8bc1\u4e66","text":"<p>\u8981\u67e5\u770bCertbot\u77e5\u9053\u7684\u8bc1\u4e66\u5217\u8868\uff0c\u8bf7\u8fd0\u884ccertificates\u5b50\u547d\u4ee4\uff1a <code>certbot certificates</code> <code>Certificate Name</code>\u663e\u793a\u8bc1\u4e66\u7684\u540d\u79f0\u3002\u4f7f\u7528<code>--cert-name</code>\u5b50\u547d\u4ee4\u6765\u6307\u5b9a\u4e00\u4e2a\u7279\u5b9a\u7684\u8bc1\u4e66\u8fdb\u884c\u64cd\u4f5c<code>run</code>\uff0c <code>certonly</code>\uff0c<code>certificates</code>\uff0c<code>renew</code>\uff0c\u548c<code>delete</code>\u547d\u4ee4\u3002\u4f8b\uff1a <code>certbot certonly --cert-name example.com</code></p>"},{"location":"common/certbot/#_8","title":"\u91cd\u65b0\u521b\u5efa\u548c\u66f4\u65b0\u73b0\u6709\u8bc1\u4e66","text":"<p>\u5373\u4f7f\u60a8\u5df2\u7ecf\u62e5\u6709\u4e00\u4e9b\u8bc1\u4e66\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5b50\u547d\u4ee4<code>certonly</code>\u6216<code>run</code>\u5b50\u547d\u4ee4\u6765\u8bf7\u6c42\u521b\u5efa\u5355\u4e2a\u65b0\u8bc1\u4e66\u3002</p> <p>\u5982\u679c\u8bf7\u6c42\u8bc1\u4e66<code>run</code>\u6216<code>certonly</code>\u6307\u5b9a\u5df2\u5b58\u5728\u7684\u8bc1\u4e66\u540d\u79f0\uff0cCertbot\u4f1a\u66f4\u65b0\u73b0\u6709\u8bc1\u4e66\u3002\u5426\u5219\uff0c\u5c06\u521b\u5efa\u4e00\u4e2a\u65b0\u8bc1\u4e66\u5e76\u5206\u914d\u6307\u5b9a\u7684\u540d\u79f0\u3002<code>\u4e00\u53e5\u8bdd\u5b58\u5728\u5c31\u66f4\u65b0\uff0c\u4e0d\u5b58\u5728\u5c31\u521b\u5efa</code>\u3002</p> <p>\u4f7f\u7528<code>--force-renewal</code>\uff0c<code>--duplicate</code>\u548c<code>--expand</code>\u9009\u9879\u5728\u91cd\u65b0\u521b\u5efa\u5df2\u7ecf\u5b58\u5728\u7684\u8bc1\u4e66\u65f6\uff0c\u63a7\u5236Certbot\u7684\u884c\u4e3a\u3002\u5982\u679c\u4f60\u6ca1\u6709\u6307\u5b9a\u8bf7\u6c42\u7684\u884c\u4e3a\uff0cCertbot\u53ef\u80fd\u4f1a\u95ee\u4f60\u4f60\u60f3\u8981\u7684\u3002\u8be5\u9009\u9879\u9ed8\u8ba4\u5305\u542b\u4e86 \u2013expand \u9009\u9879\u7684\u529f\u80fd\u3002(\u9ed8\u8ba4: False) <code>--force-renewal</code>\u544a\u8bc9Certbot\u8bf7\u6c42\u66f4\u65b0\u5df2\u7ecf\u5b58\u5728\u7684\u8bc1\u4e66\u65f6\u3002\u6bcf\u4e2a\u57df\u540d\u5fc5\u987b\u901a\u8fc7\u6307\u5b9a<code>-d</code>\u3002\u5982\u679c\u6210\u529f\uff0c\u6b64\u8bc1\u4e66\u5c06\u4e0e\u8f83\u65e9\u7684\u8bc1\u4e66\u4e00\u8d77\u4fdd\u5b58\uff0c\u5e76\u4e14\u901a\u8fc7\u7b26\u53f7\u94fe\u63a5\u5c06\u66f4\u65b0\u4e3a\u6307\u5411\u65b0\u8bc1\u4e66\u3002\u8fd9\u662f\u66f4\u65b0\u7279\u5b9a\u5355\u4e2a\u8bc1\u4e66\u7684\u6709\u6548\u65b9\u6cd5(\u8fd9\u662f\u76f4\u63a5\u66f4\u65b0\uff0c\u4e0d\u8fc7\u662f\u5426\u5c06\u8981\u8fc7\u671f)\u3002 <code>--duplicate</code>\u544a\u8bc9Certbot\u521b\u5efa\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u8bc1\u4e66\u65f6\u3002\u8be5\u8bc1\u4e66\u4e0e\u524d\u4e00\u4efd\u5b8c\u5168\u5206\u5f00\u4fdd\u5b58\u3002\u5927\u591a\u6570\u7528\u6237\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u4e0d\u9700\u8981\u53d1\u51fa\u8fd9\u4e2a\u547d\u4ee4\u3002 <code>--expand</code>\u544a\u8bc9Certbot\u4f7f\u7528\u5305\u542b\u6240\u6709\u65e7\u57df\u540d\u548c\u4e00\u4e2a\u6216\u591a\u4e2a\u989d\u5916\u65b0\u57df\u7684\u65b0\u8bc1\u4e66\u66f4\u65b0\u73b0\u6709\u8bc1\u4e66\u3002\u4f7f\u7528\u8be5<code>--expand</code>\u9009\u9879\uff0c\u4f7f\u7528\u8be5<code>-d</code>\u9009\u9879\u53ef\u4ee5\u6307\u5b9a\u6240\u6709\u73b0\u6709\u57df\u540d\u548c\u4e00\u4e2a\u6216\u591a\u4e2a\u65b0\u57df\u540d\u3002(\u9ed8\u8ba4: \u8be2\u95ee)</p> <p>\u4f8b\u5982\uff1a<code>certbot --expand -d existing.com\uff0cexample.com\uff0cnewdomain.com</code>\u4e5f\u53ef\u4ee5<code>certbot --expand -d existing.com -d example.com -d newdomain.com</code></p> <p>\u63a8\u8350\u4f7f\u7528<code>--cert-name</code>\u800c\u4e0d\u662f<code>--expand</code>\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u66f4\u597d\u5730\u63a7\u5236\u54ea\u4e2a\u8bc1\u4e66\u88ab\u4fee\u6539\uff0c\u5b83\u53ef\u4ee5\u8ba9\u4f60\u5220\u9664\u57df\u540d\u4ee5\u53ca\u6dfb\u52a0\u5b83\u4eec\u3002 <code>--allow-subset-of-names</code>\u5982\u679c\u53ea\u6709\u90e8\u5206\u6307\u5b9a\u7684\u57df\u540d\u53ef\u4ee5\u83b7\u5f97\u6388\u6743\uff0c\u5219\u544a\u8bc9Certbot\u7ee7\u7eed\u751f\u6210\u8bc1\u4e66\u3002\u5982\u679c\u8bc1\u4e66\u4e2d\u6307\u5b9a\u7684\u67d0\u4e9b\u57df\u4e0d\u518d\u6307\u5411\u8be5\u670d\u52a1\u5668\uff0c\u8fd9\u53ef\u80fd\u5f88\u6709\u7528\u3002</p> <p>\u4e0d\u7ba1\u4ec0\u4e48\u65f6\u5019\uff0c\u91c7\u7528\u8fd9\u4e9b\u65b9\u5f0f\u83b7\u53d6\u7684\u65b0\u7684\u8bc1\u4e66\u540e\u5c31\u7684\u8bc1\u4e66\u4e0d\u4f1a\u88ab\u5220\u9664\u6389\u3002</p>"},{"location":"common/certbot/#_9","title":"\u66f4\u6539\u8bc1\u4e66\u7684\u57df\u540d","text":"<p>\u4f7f\u7528<code>--cert-name</code>\u9009\u9879\u8fd8\u53ef\u7528\u4e8e\u901a\u8fc7\u4f7f\u7528<code>-d</code>\u6216<code>--domains</code>\u9009\u9879\u6307\u5b9a\u65b0\u57df\u540d\u6765\u4fee\u6539\u6216\u8005\u79fb\u9664\u8bc1\u4e66\u6240\u5305\u542b\u7684\u57df\u540d\u3002\u5982\u679c\u8bc1\u4e66<code>example.com</code> \u4ee5\u524d\u5305\u542b<code>example.com</code>\u548c<code>www.example.com</code>\uff0c\u5b83\u53ef\u4ee5\u88ab\u4fee\u6539\u4ec5\u5305\u542b<code>example.com</code>\u901a\u8fc7\u4ec5\u6307\u5b9a<code>example.com</code>\u4e0e<code>-d</code>\u6216<code>--domains</code>\u6807\u5fd7\u3002\u4f8b\uff1a <code>certbot certonly --cert-name example.com -d example.com</code></p> <p>\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u683c\u5f0f\u6765\u6269\u5c55\u8be5\u8bc1\u4e66\u7684\u57df\u540d\u96c6\u6216\u8005\u66ff\u6362\u8be5\u8bc1\u4e66\u7684\u57df\u540d\u96c6 <code>certbot certonly --cert-name example.com -d example.org,www.example.org</code></p>"},{"location":"common/certbot/#_10","title":"\u6ce8\u9500\u8bc1\u4e66","text":"<p>\u5982\u679c\u60a8\u7684\u8d26\u6237\u5bc6\u94a5\u5df2\u88ab\u76d7\u7528\u6216\u60a8\u9700\u8981\u64a4\u9500\u8bc1\u4e66\uff0c\u8bf7\u4f7f\u7528\u8be5<code>revoke</code>\u547d\u4ee4\u6765\u6267\u884c\u6b64\u64cd\u4f5c\u3002\u8bf7\u6ce8\u610f\uff0c\u8be5<code>revoke</code>\u547d\u4ee4\u91c7\u7528\u8bc1\u4e66\u8def\u5f84\uff08\u4ee5\u7ed3\u5c3ecert.pem\uff09\uff0c\u800c\u4e0d\u662f\u8bc1\u4e66\u540d\u79f0\u6216\u57df\u540d\u3002\u4f8b\uff1a <code>certbot revoke --cert-path /etc/letsencrypt/live/CERTNAME/cert.pem</code></p> <p>\u60a8\u8fd8\u53ef\u4ee5\u4f7f\u7528\u8be5<code>reason</code>\u6807\u5fd7\u6307\u5b9a\u64a4\u6d88\u8bc1\u4e66\u7684\u539f\u56e0\u3002\u539f\u56e0\u5305\u62ec\uff1a<code>unspecified</code>\u8fd9\u662f\u9ed8\u8ba4\u7684\uff0c\u4ee5\u53ca<code>keycompromise</code>\uff0c <code>affiliationchanged</code>\uff0c<code>superseded</code>\uff0c\u548c<code>cessationofoperation</code>\uff1a <code>certbot revoke --cert-path /etc/letsencrypt/live/CERTNAME/cert.pem --reason keycompromise</code></p> <p>\u6b64\u5916\uff0c\u5982\u679c\u8bc1\u4e66\u662f\u901a\u8fc7<code>--staging</code>\u6216<code>--test-cert</code>\u9009\u9879\u83b7\u5f97\u7684\u6d4b\u8bd5\u8bc1\u4e66\uff0c\u5219\u8be5\u9009\u9879\u5fc5\u987b\u4f20\u9012\u7ed9 <code>revoke</code>\u5b50\u547d\u4ee4\u3002 <code>certbot revoke --cert-path /etc/letsencrypt/live/CERTNAME/cert.pem --staging</code></p> <p>\u6216\u8005\uff1a <code>certbot revoke --cert-path /etc/letsencrypt/live/CERTNAME/cert.pem --test-cert</code> \u4e00\u65e6\u8bc1\u4e66\u88ab\u540a\u9500\uff08\u6216\u5176\u4ed6\u8bc1\u4e66\u7ba1\u7406\u4efb\u52a1\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528<code>delete</code>\u5b50\u547d\u4ee4\u4ece\u7cfb\u7edf\u4e2d\u5220\u9664\u6240\u6709\u8bc1\u4e66\u7684\u76f8\u5173\u6587\u4ef6\uff1a <code>certbot delete --cert-name example.com</code></p> <p>\u5982\u679c\u60a8\u4e0d\u4f7f\u7528<code>delete</code>\u5b8c\u5168\u5220\u9664\u8bc1\u4e66\uff0c\u5b83\u5c06\u5728\u8bc1\u4e66\u66f4\u65b0\u65f6\u81ea\u52a8\u66f4\u65b0\u3002 \u64a4\u9500\u8bc1\u4e66\u4e0d\u4f1a\u5f71\u54cdLet\u2019s Encrypt\u670d\u52a1\u5668\u65bd\u52a0\u7684\u901f\u7387\u9650\u5236\u3002</p>"},{"location":"common/certbot/#_11","title":"\u66f4\u65b0\u8bc1\u4e66","text":"<p>\u8ba9\u6211\u4eec\u52a0\u5bc6CA\u53d1\u5e03\u77ed\u671f\u8bc1\u4e66\uff0890\u5929\uff09\u3002\u786e\u4fdd\u60a8\u57283\u4e2a\u6708\u5185\u81f3\u5c11\u7eed\u7b7e\u4e00\u6b21\u8bc1\u4e66\u3002 \u4ece\u7248\u672c0.10.0\u5f00\u59cb\uff0cCertbot\u652f\u6301<code>renew</code>\u68c0\u67e5\u6240\u6709\u5df2\u5b89\u88c5\u7684\u8bc1\u4e66\u662f\u5426\u5373\u5c06\u5230\u671f\u5e76\u5c1d\u8bd5\u5bf9\u5176\u8fdb\u884c\u66f4\u65b0\u3002\u6700\u7b80\u5355\u7684\u5f62\u5f0f\u5f88\u7b80\u5355 <code>certbot renew``renew</code>\u547d\u4ee4\u4f1a\u68c0\u67e5\u6240\u6709\u7684\u8bc1\u4e66\u5e76\u66f4\u65b0<code>30\u5929\u5185\u8fc7\u671f</code>\u7684\u8bc1\u4e66\uff08\u5982\u679c\u4e0d\u6307\u5b9a\u4f7f\u7528\u7684\u63d2\u4ef6\u548c\u9009\u9879\uff0c\u4f8b\u5982\u7533\u8bf7\u8bc1\u4e66\u65f6\u4f7f\u7528<code>apache</code>\u90a3\u4e48\u66f4\u65b0\u65f6\u8fd8\u8bf4\u8be5\u53c2\u6570\uff0c\u5982\u679c\u60f3\u8981\u6539\u53d8\u5728\u540e\u9762\u8ddf\u4e0a\u5176\u5b83\u53c2\u6570\u5373\u53ef\uff09\uff0c\u7531\u4e8e<code>renew</code>\u53ea\u66f4\u65b0\u5feb\u8fc7\u671f\u7684\u8bc1\u4e66\uff0c\u6240\u4ee5\u53ef\u4ee5\u968f\u610f\u7684\u4f7f\u7528\u3002 <code>renew</code>\u547d\u4ee4\u53ef\u4ee5\u4f7f\u7528hook\u94a9\u5b50\uff0c\u4f8b\u5982\uff1a\u5982\u679c\u4f7f\u7528<code>webroot</code>\u65b9\u5f0f\uff0c\u90a3\u4e48\u5728\u66f4\u65b0\u524d\u9700\u8981\u5173\u95ed\u670d\u52a1\u5668\u91ca\u653e80\u7aef\u53e3\u5728\u66f4\u65b0\u540e\u9700\u8981\u542f\u52a8\u670d\u52a1\u5668\u3002</p> <p>certbot renew \u2013pre-hook \u201cservice nginx stop\u201d \u2013post-hook \u201cservice nginx start\u201d <code>--pre-hook</code>\u5728\u5c1d\u8bd5\u66f4\u65b0\u524d\u8c03\u7528 <code>--post-hook</code>\u5728\u66f4\u65b0\u4e4b\u540e\u8c03\u7528\uff0c\u4e0d\u8bba\u6210\u529f\u6216\u8005\u5931\u8d25 <code>--deploy-hook</code>\u5728\u66f4\u65b0\u6210\u529f\u540e\u8c03\u7528</p> <p>\u4f8b\u5b50\uff1a\u5728\u66f4\u65b0\u6210\u529f\u540e\u8c03\u7528\u811a\u672c  <code>certbot renew --deploy-hook /path/to/deploy-hook-script</code></p> <p>\u5982\u679c\u5b58\u5728\u4e00\u4e2a\u5b88\u62a4\u7a0b\u5e8f\u4e0d\u662f\u4ee5<code>root</code>\u7684\u8eab\u4efd\u8bfb\u53d6\u8bc1\u4e66\uff0c\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528<code>--deploy-hook</code>\u94a9\u5b50\u5c06\u5176\u590d\u5236\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\u5e76\u5e94\u7528\u9002\u5f53\u7684\u6587\u4ef6\u6743\u9650\u3002 \u793a\u4f8b\u811a\u672c\uff1a</p> <pre><code>#!/bin/sh\n\nset -e\n\nfor domain in $RENEWED_DOMAINS; do\n        case $domain in\n        example.com)\n                daemon_cert_root=/etc/some-daemon/certs\n\n                # Make sure the certificate and private key files are\n                # never world readable, even just for an instant while\n                # we're copying them into daemon_cert_root.\n                umask 077\n\n                cp \"$RENEWED_LINEAGE/fullchain.pem\" \"$daemon_cert_root/$domain.cert\"\n                cp \"$RENEWED_LINEAGE/privkey.pem\" \"$daemon_cert_root/$domain.key\"\n\n                # Apply the proper file ownership and permissions for\n                # the daemon to read its certificate and key.\n                chown some-daemon \"$daemon_cert_root/$domain.cert\" \\\n                        \"$daemon_cert_root/$domain.key\"\n                chmod 400 \"$daemon_cert_root/$domain.cert\" \\\n                        \"$daemon_cert_root/$domain.key\"\n\n                service some-daemon restart &gt;/dev/null\n                ;;\n        esac\ndone\n</code></pre> <p>\u5982\u679c\u5728\u67d0\u4e9b\u94a9\u5b50\u4e0b\u6709\u591a\u4e2a\u9700\u8981\u6267\u884c\u7684\u811a\u672c\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5c06\u6587\u4ef6\u653e\u5728Certbot\u7684\u914d\u7f6e\u76ee\u5f55\u7684\u5b50\u76ee\u5f55\u4e2d\u6765\u6267\u884c\u6302\u94a9\u3002\u5047\u8bbe\u60a8\u7684\u914d\u7f6e\u76ee\u5f55\u662f <code>/etc/letsencrypt</code>\uff0c\u5f53\u4f7f\u7528\u5b50\u547d\u4ee4\u66f4\u65b0\u4efb\u4f55\u8bc1\u4e66\u65f6\uff0c\u5c06\u5206\u522b\u5728\u66f4\u65b0\u524d\u6267\u884c<code>pre</code>\u76ee\u5f55\u4e2d\u7684\u811a\u672c<code>/etc/letsencrypt/renewal-hooks/pre</code>\uff0c\u548c\u66f4\u65b0\u6210\u529f\u540e<code>deploy</code>\u76ee\u5f55\u4e2d\u7684\u811a\u672c<code>/etc/letsencrypt/renewal-hooks/deploy</code>\u8fd9\u4e9b\u94a9\u5b50\u6309\u5b57\u6bcd\u987a\u5e8f\u8fd0\u884c\uff0c\u4e0d\u4f1a\u4e3a\u5176\u4ed6\u5b50\u547d\u4ee4\u8fd0\u884c\u3002\uff08\u6302\u94a9\u8fd0\u884c\u7684\u987a\u5e8f\u7531\u5176\u6587\u4ef6\u540d\u4e2d\u5b57\u7b26\u7684\u5b57\u8282\u503c\u51b3\u5b9a\uff0c\u5e76\u4e14\u4e0d\u4f9d\u8d56\u4e8e\u60a8\u7684\u8bed\u8a00\u73af\u5883\u3002\uff09</p> <p>\u6709\u5173\u94a9\u5b50\u7684\u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c<code>certbot --help renew</code>\u627e\u5230\u3002 \u5982\u679c\u6267\u884c\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u9519\u8bef\uff08\u8fd4\u56de\u975e0\u7684\u72b6\u6001\u7801\uff09\u90a3\u4e48\u9519\u8bef\u4f1a\u88ab\u8f93\u51fa\u5230<code>stderr</code>\u3002\u53ef\u4ee5\u5728\u540e\u9762\u52a0\u4e0a<code>-q</code>\u6216\u8005<code>--quiet</code>\u6765\u4f7f\u9664\u9519\u8bef\u4ee5\u5916\u7684\u6240\u6709\u8f93\u51fa\u4fdd\u6301\u6c89\u9ed8\u3002 \u6ce8\u610f\uff0c\u5728\u66f4\u65b0\u8bc1\u4e66\u4e2d\u6307\u5b9a\u7684\u9009\u9879\u4f1a\u5e94\u7528\u5230\u8bf4\u4ee5\u7684\u8bc1\u4e66\u4e0a\u9762\uff0c\u5982\u679c\u66f4\u65b0\u6210\u529f\u5c06\u4f1a\u4fdd\u5b58\u8be5\u9009\u9879\u5e76\u5c06\u5728\u4e0b\u6b21\u66f4\u65b0\u65f6\u518d\u6b21\u4f7f\u7528\u3002<code>certbot renew``certbot renew --rsa-key-size 4096</code></p> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\u66f4\u65b0\u8bc1\u4e66\u4f7f\u7528\u7684cron\u8ba1\u5212\u4efb\u52a1\u5b9a\u65f6\u66f4\u65b0\uff0c\u6240\u4ee5\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u4e0d\u60f3\u51fa\u73b0\u4efb\u4f55\u9700\u8981\u7528\u6237\u8f93\u5165\u7684\u53c2\u6570\uff0c\u53ef\u4ee5\u4f7f\u7528<code>-n</code>\u6216\u8005<code>--noninteractive</code> <code>certbot certonly -n -d example.com -d www.example.com</code></p> <p>\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5fc5\u987b\u6307\u5b9a\u8bc1\u4e66\u5305\u6db5\u7684\u6240\u6709\u57df\u540d\uff0c\u4ee5\u4fbf\u66f4\u65b0\u8bc1\u4e66\uff0c\u5982\u679c\u57df\u540d\u4e0d\u4e00\u81f4\u5c06\u4f1a\u66ff\u6362\u8bc1\u4e66\u3002</p> <p>\u5982\u679c\u8bc1\u4e66\u5feb\u5230\u671f\u5e76\u4e14\u6ca1\u6709\u66f4\u65b0CA\u5c06\u4f1a\u7ed9\u63d0\u4f9b\u7684\u90ae\u7bb1\u53d1\u7535\u5b50\u90ae\u4ef6\u3002</p>"},{"location":"common/certbot/#_12","title":"\u4fee\u6539\u66f4\u65b0\u914d\u7f6e\u6587\u4ef6","text":"<p>\u5728\u9881\u53d1\u8bc1\u4e66\u65f6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u521b\u5efa\u4e00\u4e2a\u7eed\u8ba2\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u7528\u4e8e\u7eed\u8ba2\u65f6\u4f7f\u7528\u548c\u9881\u53d1\u8bc1\u4e66\u65f6\u76f8\u540c\u7684\u9009\u9879\uff0c\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e<code>/etc/letsencrypt/renewal/CERTNAME</code></p> <p>\u5982\u679c\u4e0d\u662f\u5fc5\u8981\u4e0d\u5efa\u8bae\u4fee\u6539\u7eed\u8ba2\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u679c\u624b\u52a8\u4fee\u6539\u540e\uff0c\u5efa\u8bae\u901a\u8fc7<code>certbot renew --dry-run</code>\u8fdb\u884c\u6d4b\u8bd5\u914d\u7f6e\u6587\u4ef6\u7684\u6709\u6548\u6027</p> <p>\u5982\u679c\u5c06\u7eed\u8ba2\u914d\u7f6e\u6587\u4ef6<code>/etc/letsencrypt/archive/CERTNAME</code>\u79fb\u52a8\u5230\u65b0\u6587\u4ef6\u5939\uff0c\u8bf7\u5148\u5728\u7eed\u8ba2\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u65b0\u6587\u4ef6\u5939\u7684\u540d\u79f0\uff0c\u7136\u540e\u8fd0\u884c\u4ee5\u5c06\u7b26\u53f7\u94fe\u63a5\u6307\u5411\u65b0\u6587\u4ef6\u5939\u3002 <code>certbot update_symlinks /etc/letsencrypt/live/CERTNAME</code> \u5982\u679c\u9700\u8981\u4fee\u6539\u751f\u6210\u8bc1\u4e66\u7684\u76ee\u5f55\u6216\u8005\u4fee\u6539\u8fc7\u671f\u8bc1\u4e66\u7684\u76ee\u5f55\u7b49\u7b49\u9700\u8981\u8c03\u7528<code>certbot update_symlinks</code>\u66f4\u65b0</p> <p>\u4f8b\u5982\uff1a\u8bc1\u4e66\u7684\u7eed\u8ba2\u914d\u7f6e\u6587\u4ef6\u5305\u542b\u4ee5\u4e0b\u6307\u4ee4</p> <pre><code>archive_dir = /etc/letsencrypt/archive/example.com  \ncert = /etc/letsencrypt/live/example.com/cert.pem  \nprivkey = /etc/letsencrypt/live/example.com/privkey.pem  \nchain = /etc/letsencrypt/live/example.com/chain.pem  \nfullchain = /etc/letsencrypt/live/example.com/fullchain.pem  \n</code></pre> <p>\u66f4\u6539\u4f4d\u7f6e\uff1a</p> <pre><code>mv /etc/letsencrypt/archive/example.com /home/user/me/certbot/example_archive\nsed -i 's,/etc/letsencrypt/archive/example.com,/home/user/me/certbot/example_archive,' /etc/letsencrypt/renewal/example.com.conf\nmv /etc/letsencrypt/live/example.com/*.pem /home/user/me/certbot/\nsed -i 's,/etc/letsencrypt/live/example.com,/home/user/me/certbot,g' /etc/letsencrypt/renewal/example.com.conf\ncertbot update_symlinks\n</code></pre>"},{"location":"common/certbot/#_13","title":"\u81ea\u52a8\u7eed\u8ba2","text":"<p>\u4f7f\u7528cron\u8ba1\u5212\u4efb\u52a1\u5b9a\u65f6\u6267\u884c</p>"},{"location":"common/certbot/#_14","title":"\u8bc1\u4e66\u4f4d\u7f6e","text":"<p>\u6240\u6709\u751f\u6210\u7684\u5bc6\u94a5\u548c\u9881\u53d1\u7684\u8bc1\u4e66\u90fd\u53ef\u4ee5\u5728\u4e2d\u627e\u5230 /etc/letsencrypt/live/$domain\u3002\u8bf7\u52ff\u5c06\u60a8\u7684\uff08\u7f51\u7edc\uff09\u670d\u52a1\u5668\u914d\u7f6e\u76f4\u63a5\u6307\u5411\u8fd9\u4e9b\u6587\u4ef6\uff08\u6216\u521b\u5efa\u7b26\u53f7\u94fe\u63a5\uff09\uff0c\u800c\u4e0d\u8981\u590d\u5236\u3002\u66f4\u65b0\u671f\u95f4\uff0c/etc/letsencrypt/live\u4f1a\u66f4\u65b0\u6700\u65b0\u7684\u5fc5\u8981\u6587\u4ef6\u3002 <code>/etc/letsencrypt/archive</code>\u548c<code>/etc/letsencrypt/keys</code>\u5305\u542b\u6240\u6709\u4ee5\u524d\u7684\u5bc6\u94a5\u548c\u8bc1\u4e66\uff0c\u800c <code>/etc/letsencrypt/live</code>\u7b26\u53f7\u94fe\u63a5\u5230\u6700\u65b0\u7248\u672c\u3002</p>"},{"location":"common/certbot/#_15","title":"\u751f\u6210\u7684\u6587\u4ef6","text":"<p><code>privkey.pem</code> \u79c1\u94a5\u6587\u4ef6\uff0c\u5fc5\u987b\u4e25\u5bc6\u4fdd\u5b58\uff0c\u8fd9\u5c31\u662fApache\u9700\u8981\u7684SSLCertificateKeyFile\uff0c\u4ee5\u53caNginx\u9700\u8981\u7684ssl_certificate_key\u3002 <code>fullchain.pem</code> \u8bc1\u4e66\uff0c\u8fd9\u5c31\u662fApache&gt; = 2.4.8\u6240\u9700\u7684SSLCertificateFile\uff0c\u4ee5\u53caNginx\u9700\u8981\u7684ssl_certificate\u3002 <code>cert.pem</code>\u548c<code>chain.pem</code>\uff08\u4e0d\u592a\u5e38\u89c1\uff09 <code>cert.pem</code>\u5305\u542b\u670d\u52a1\u5668\u8bc1\u4e66\u548c<code>chain.pem</code>\u4e2d\u95f4\u8bc1\u4e66\uff08\u8bc1\u4e66\u94fe\uff09\u5fc5\u987b\u540c\u65f6\u4f7f\u7528\u624d\u6709\u6548 Apache &lt;2.4.8\u9700\u8981\u8fd9\u4e9b\u7528\u4e8eSSLCertificateFile\u3002\u548cSSLCertificateChainFile\u3002\u5982\u679c\u4f7f\u7528Nginx&gt; = 1.3.7\u7684OCSP\u88c5\u8ba2\uff0c<code>chain.pem</code>\u5e94\u8be5\u63d0\u4f9bssl_trusted_certificate \u6765\u9a8c\u8bc1OCSP\u54cd\u5e94\u3002</p> <p>\u6240\u6709\u6587\u4ef6\u90fd\u662fPEM\u7f16\u7801\u7684\u3002\u5982\u679c\u60a8\u9700\u8981\u5176\u4ed6\u683c\u5f0f\uff0c\u4f8b\u5982DER\u6216PFX\uff0c\u90a3\u4e48\u60a8\u53ef\u4ee5\u4f7f\u7528\u8f6c\u6362<code>openssl</code>\u3002\u5728\u66f4\u65b0\u5b8c\u6210\u540e\u901a\u8fc7\u89e6\u53d1\u94a9\u5b50<code>--deploy-hook</code>\u8c03\u7528<code>openssl</code>\u8fdb\u884c\u8f6c\u5316\u3002</p>"},{"location":"common/certbot/#manual_1","title":"manual\u9a8c\u8bc1\u524d\u540e\u94a9\u5b50","text":"<p>\u5728<code>Manual</code>\u6a21\u5f0f\u8fd0\u884c\u65f6\u6709\u4e24\u4e2a\u94a9\u5b50\u9a8c\u8bc1\u524d\u548c\u9a8c\u8bc1\u540e\u4f1a\u89e6\u53d1<code>--manual-auth-hook</code>\u548c<code>--manual-cleanup-hook</code> <code>certbot certonly --manual --manual-auth-hook /path/to/http/authenticator.sh --manual-cleanup-hook /path/to/http/cleanup.sh -d secure.example.com</code> \u5c06\u4f1a\u4f20\u9012\u4ee5\u4e0b\u53d8\u91cf\u7ed9\u811a\u672c\uff1a <code>CERTBOT_DOMAIN</code>: \u88ab\u8ba4\u8bc1\u7684\u57df\u540d <code>CERTBOT_VALIDATION</code>:\u9a8c\u8bc1\u5b57\u7b26\u4e32\uff08\u4ec5\u9650HTTP-01\u548cDNS-01\uff09 <code>CERTBOT_TOKEN</code>: HTTP-01\u9a8c\u8bc1\u7684\u8d44\u6e90\u540d\u79f0\u90e8\u5206\uff08\u4ec5\u9650HTTP-01\uff09 <code>CERTBOT_CERT_PATH</code>: \u6311\u6218SSL\u8bc1\u4e66\uff08\u4ec5\u9650TLS-SNI-01\uff09 <code>CERTBOT_KEY_PATH</code>: \u4e0e\u4e0a\u8ff0SSL\u8bc1\u4e66\u5173\u8054\u7684\u79c1\u94a5\uff08\u4ec5\u9650TLS-SNI-01\uff09 <code>CERTBOT_SNI_DOMAIN</code>: ACME\u670d\u52a1\u5668\u5e0c\u671b\u4e3a\u5176\u63d0\u4f9b\u4f4d\u4e8e<code>$CERTBOT_CERT_PATH</code>\uff08\u4ec5\u9650TLS-SNI-01\uff09\u7684\u81ea\u7b7e\u540d\u8bc1\u4e66\u7684SNI\u540d\u79f0</p> <p>cleanup \u8f93\u51fa\uff1a <code>CERTBOT_AUTH_OUTPUT</code>: \u65e0\u8bba\u5982\u4f55auth\u811a\u672c\u5199\u5165\u6807\u51c6\u8f93\u51fa <code>certbot certonly --manual --preferred-challenges=http --manual-auth-hook /path/to/http/authenticator.sh --manual-cleanup-hook /path/to/http/cleanup.sh -d secure.example.com</code></p> <p>HTTP-01\u7684\u793a\u4f8b\u7528\u6cd5\uff1a <code>certbot certonly --manual --preferred-challenges=http --manual-auth-hook /path/to/http/authenticator.sh --manual-cleanup-hook /path/to/http/cleanup.sh -d secure.example.com</code></p> <p>/path/to/http/authenticator.sh</p> <pre><code>#!/bin/bashecho$CERTBOT_VALIDATION&gt; /var/www/htdocs/.well-known/acme-challenge/$CERTBOT_TOKEN\n</code></pre> <p>/path/to/http/cleanup.sh</p> <pre><code>#!/bin/bash\nrm -f /var/www/htdocs/.well-known/acme-challenge/$CERTBOT_TOKEN\n</code></pre> <p>DNS-01\uff08Cloudflare API v4\uff09\u7684\u793a\u4f8b\u7528\u6cd5\uff08\u4ec5\u7528\u4e8e\u793a\u4f8b\u76ee\u7684\uff0c\u8bf7\u52ff\u6309\u539f\u6837\u4f7f\u7528\uff09 <code>certbot certonly --manual --preferred-challenges=dns --manual-auth-hook /path/to/dns/authenticator.sh --manual-cleanup-hook /path/to/dns/cleanup.sh -d secure.example.com</code> /path/to/dns/authenticator.sh</p> <pre><code>#!/bin/bash\n\n# Get your API key from https://www.cloudflare.com/a/account/my-account\nAPI_KEY=\"your-api-key\"\nEMAIL=\"your.email@example.com\"\n\n# Strip only the top domain to get the zone id\nDOMAIN=$(expr match \"$CERTBOT_DOMAIN\" '.*\\.\\(.*\\..*\\)')\n\n# Get the Cloudflare zone id\nZONE_EXTRA_PARAMS=\"status=active&amp;page=1&amp;per_page=20&amp;order=status&amp;direction=desc&amp;match=all\"\nZONE_ID=$(curl -s -X GET \"https://api.cloudflare.com/client/v4/zones?name=$DOMAIN&amp;$ZONE_EXTRA_PARAMS\" \\\n     -H     \"X-Auth-Email: $EMAIL\" \\\n     -H     \"X-Auth-Key: $API_KEY\" \\\n     -H     \"Content-Type: application/json\" | python -c \"import sys,json;print(json.load(sys.stdin)['result'][0]['id'])\")\n\n# Create TXT record\nCREATE_DOMAIN=\"_acme-challenge.$CERTBOT_DOMAIN\"\nRECORD_ID=$(curl -s -X POST \"https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records\" \\\n     -H     \"X-Auth-Email: $EMAIL\" \\\n     -H     \"X-Auth-Key: $API_KEY\" \\\n     -H     \"Content-Type: application/json\" \\\n     --data '{\"type\":\"TXT\",\"name\":\"'\"$CREATE_DOMAIN\"'\",\"content\":\"'\"$CERTBOT_VALIDATION\"'\",\"ttl\":120}' \\\n             | python -c \"import sys,json;print(json.load(sys.stdin)['result']['id'])\")\n# Save info for cleanup\nif [ ! -d /tmp/CERTBOT_$CERTBOT_DOMAIN ];then\n        mkdir -m 0700 /tmp/CERTBOT_$CERTBOT_DOMAIN\nfi\necho $ZONE_ID &gt; /tmp/CERTBOT_$CERTBOT_DOMAIN/ZONE_ID\necho $RECORD_ID &gt; /tmp/CERTBOT_$CERTBOT_DOMAIN/RECORD_ID\n\n# Sleep to make sure the change has time to propagate over to DNS\nsleep 25\n</code></pre> <p>/path/to/dns/cleanup.sh</p> <pre><code>#!/bin/bash\n\n# Get your API key from https://www.cloudflare.com/a/account/my-account\nAPI_KEY=\"your-api-key\"\nEMAIL=\"your.email@example.com\"\n\nif [ -f /tmp/CERTBOT_$CERTBOT_DOMAIN/ZONE_ID ]; then\n        ZONE_ID=$(cat /tmp/CERTBOT_$CERTBOT_DOMAIN/ZONE_ID)\n        rm -f /tmp/CERTBOT_$CERTBOT_DOMAIN/ZONE_ID\nfi\n\nif [ -f /tmp/CERTBOT_$CERTBOT_DOMAIN/RECORD_ID ]; then\n        RECORD_ID=$(cat /tmp/CERTBOT_$CERTBOT_DOMAIN/RECORD_ID)\n        rm -f /tmp/CERTBOT_$CERTBOT_DOMAIN/RECORD_ID\nfi\n\n# Remove the challenge TXT record from the zone\nif [ -n \"${ZONE_ID}\" ]; then\n    if [ -n \"${RECORD_ID}\" ]; then\n        curl -s -X DELETE \"https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID\" \\\n                -H \"X-Auth-Email: $EMAIL\" \\\n                -H \"X-Auth-Key: $API_KEY\" \\\n                -H \"Content-Type: application/json\"\n    fi\nfi\n</code></pre>"},{"location":"common/certbot/#acme","title":"\u66f4\u6539ACME\u670d\u52a1\u5668","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cCertbot\u4f7f\u7528\u5728\u52a0\u5bc6\u7684\u521d\u59cb\u751f\u4ea7\u670d\u52a1\u5668 https://acme-v01.api.letsencrypt.org/\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7<code>--server</code>\u5728\u547d\u4ee4\u884c\u6216\u914d\u7f6e\u6587\u4ef6\u63d0\u4f9b\u670d\u52a1\u5668\u7684ACME\u76ee\u5f55\u7684URL \u6765\u544a\u8bc9Certbot\u4f7f\u7528\u4e0d\u540c\u7684CA\u670d\u52a1\u5668. \u4f8b\u5982\uff0c\u5982\u679c\u60a8\u60f3\u4f7f\u7528Let\u2019s Encrypt\u7684\u65b0ACMEv2\u670d\u52a1\u5668\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4\u884c\u6267\u884c<code>--server https://acme-v02.api.letsencrypt.org/directory</code>\u3002Certbot\u5c06\u6839\u636eURL\u63d0\u4f9b\u7684\u5185\u5bb9\u81ea\u52a8\u9009\u62e9\u8981\u4f7f\u7528\u7684ACME\u534f\u8bae\u7248\u672c\u3002</p> <p>\u5982\u679c\u60a8\u4f7f\u7528<code>--server</code>\u6307\u5b9a\u5b9e\u73b0\u65b0\u7248\u672c\u89c4\u8303\u7684ACME CA\uff0c\u5219\u53ef\u4ee5\u83b7\u5f97\u901a\u914d\u7b26\u57df\u7684\u8bc1\u4e66\u3002\u6709\u4e9bCA\uff08\u4f8b\u5982Let\u2019s Encrypt\uff09\u8981\u6c42\u901a\u914d\u7b26\u57df\u7684\u57df\u9a8c\u8bc1\u5fc5\u987b\u901a\u8fc7\u4fee\u6539DNS\u8bb0\u5f55\u6765\u5b8c\u6210\uff0c\u8fd9\u610f\u5473\u7740\u5fc5\u987b\u4f7f\u7528dns-01\u9a8c\u8bc1\u7c7b\u578b\u3002\u8981\u67e5\u770b\u652f\u6301\u8be5\u6311\u6218\u7c7b\u578b\u7684Certbot\u63d2\u4ef6\u5217\u8868\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5b83\u4eec\uff0c\u8bf7\u53c2\u9605\u63d2\u4ef6\u3002</p>"},{"location":"common/certbot/#_16","title":"\u9501\u5b9a\u6587\u4ef6","text":"<p>\u5904\u7406\u9a8c\u8bc1\u65f6\uff0cCertbot\u4f1a\u5728\u60a8\u7684\u7cfb\u7edf\u4e0a\u5199\u5165\u591a\u4e2a\u9501\u5b9a\u6587\u4ef6\uff0c\u4ee5\u9632\u6b62\u591a\u4e2a\u5b9e\u4f8b\u8986\u76d6\u5f7c\u6b64\u7684\u66f4\u6539\u3002\u8fd9\u610f\u5473\u7740\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cCertbot\u7684\u4e24\u4e2a\u5b9e\u4f8b\u5c06\u4e0d\u80fd\u5e76\u884c\u8fd0\u884c\u3002 </p> <p>\u7531\u4e8eCertbot\u4f7f\u7528\u7684\u76ee\u5f55\u662f\u53ef\u914d\u7f6e\u7684\uff0cCertbot\u5c06\u4e3a\u5b83\u4f7f\u7528\u7684\u6240\u6709\u76ee\u5f55\u7f16\u5199\u4e00\u4e2a\u9501\u5b9a\u6587\u4ef6\u3002\u8fd9\u5305\u62ecCertbot\u7684 <code>--work-dir</code>\uff0c<code>--logs-dir</code>\u548c<code>--config-dir</code>\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e9b\u90fd\u662f <code>/var/lib/letsencrypt</code>\uff0c<code>/var/logs/letsencrypt</code>\u548c<code>/etc/letsencrypt</code> \u3002\u53e6\u5916\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u5e26\u6709Apache\u6216nginx\u7684Certbot\uff0c\u5b83\u5c06\u9501\u5b9a\u8be5\u7a0b\u5e8f\u7684\u914d\u7f6e\u6587\u4ef6\u5939\uff0c\u8fd9\u901a\u5e38\u4e5f\u4f4d\u4e8e <code>/etc</code>\u76ee\u5f55\u4e2d\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u8fd9\u4e9b\u9501\u5b9a\u6587\u4ef6\u53ea\u4f1a\u963b\u6b62\u5176\u4ed6Certbot\u5b9e\u4f8b\u4f7f\u7528\u8fd9\u4e9b\u76ee\u5f55\uff0c\u800c\u4e0d\u4f1a\u963b\u6b62\u5176\u4ed6\u8fdb\u7a0b\u3002\u5982\u679c\u4f60\u60f3\u540c\u65f6\u8fd0\u884c\u591a\u4e2aCertbot\u5b9e\u4f8b\u5e94\u4e3a\u6bcf\u4e2aCertbot\u6307\u5b9a\u4e0d\u540c\u7684\u76ee\u5f55\u4e2d<code>--work-dir</code>\uff0c<code>--logs-dir</code>\u548c<code>--config-dir</code>\u3002</p>"},{"location":"common/certbot/#_17","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>Certbot\u63a5\u53d7\u5168\u5c40\u914d\u7f6e\u6587\u4ef6\uff0c\u5c06\u5176\u9009\u9879\u5e94\u7528\u4e8eCertbot\u7684\u6240\u6709\u8c03\u7528\u3002\u5e94\u5728<code>.conf</code>\u91cc\u9762\u627e\u5230\u7684\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u8bc1\u4e66\u7279\u5b9a\u7684\u914d\u7f6e\u9009\u9879<code>/etc/letsencrypt/renewal</code>\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e0d\u4f1a\u521b\u5efa<code>cli.ini</code>\u6587\u4ef6\uff0c\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\u540e\u53ef\u4ee5\u6307\u5b9a\u8be5\u914d\u7f6e\u6587\u4ef6\u7684\u4f4d\u7f6e\uff09\u3002\u793a\u4f8b\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a<code>certbot --config</code>\u6216\u8005 <code>certbot cli.ini-c cli.ini</code></p> <pre><code> This is an example of the kind of things you can do in a configuration file.\n# All flags used by the client can be configured here. Run Certbot with\n# \"--help\" to learn more about the available options.\n# \u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u6240\u6709\u6807\u5fd7\u90fd\u53ef\u4ee5\u5728\u8fd9\u91cc\u914d\u7f6e --help \u4e86\u89e3\u66f4\u591a\u4fe1\u606f\n#\n# Note that these options apply automatically to all use of Certbot for\n# obtaining or renewing certificates, so options specific to a single\n# certificate on a system with several certificates should not be placed\n# here.\n# \u8fd9\u4e9b\u9009\u9879\u4f1a\u5e94\u7528\u4e8e\u6240\u6709\u7684certbot\u6765\u83b7\u53d6\u6216\u8005\u66f4\u65b0\u8bc1\u4e66\u3002\u56e0\u6b64\uff0c\u4e0d\u5e94\u5728\u8fd9\u91cc\u653e\u7f6e\u7279\u5b9a\u4e8e\u5177\u6709\u591a\u4e2a\u8bc1\u4e66\u7684\u7cfb\u7edf\u4e0a\u7684\u5355\u4e2a\n\uff03\u8bc1\u4e66\u7684\u9009\u9879\n\n# Use a 4096 bit RSA key instead of 2048\n# \u4f7f\u75284096\u4f4dRSA\u5bc6\u94a5\u800c\u4e0d\u662f2048\nrsa-key-size = 4096\n\n# Uncomment and update to register with the specified e-mail address\n# \u53d6\u6d88\u6ce8\u518c\u5e76\u66f4\u65b0\u4ee5\u6ce8\u518c\u6307\u5b9a\u7684\u7535\u5b50\u90ae\u4ef6\u5730\u5740\n# email = foo@example.com\n\n# Uncomment to use the standalone authenticator on port 443\n# \u53d6\u6d88\u5728\u7aef\u53e3443\u4e0a\u4f7f\u7528\u72ec\u7acb\u9a8c\u8bc1\u5668\u7684\u6ce8\u91ca\n# authenticator = standalone\n# standalone-supported-challenges = tls-sni-01\n\n# Uncomment to use the webroot authenticator. Replace webroot-path with the\n# path to the public_html / webroot folder being served by your web server.\n# \u53d6\u6d88\u6ce8\u91ca\u4ee5\u4f7f\u7528webroot\u8eab\u4efd\u9a8c\u8bc1\u5668\u3002\u5c06webroot-path\u66ff\u6362\u4e3a\u7531\u60a8\u7684Web\u670d\u52a1\u5668\u63d0\u4f9b\u7684public_html / webroot\u6587\u4ef6\u5939\n\u7684\uff03\u8def\u5f84\n# authenticator = webroot\n# webroot-path = /usr/share/nginx/html\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u641c\u7d22\u4ee5\u4e0b\u4f4d\u7f6e\uff1a <code>/etc/letsencrypt/cli.ini</code> <code>$XDG_CONFIG_HOME/letsencrypt/cli.ini</code>\uff08\u5982\u679c$XDG_CONFIG_HOME\u6ca1\u6709\u8bbe\u7f6e\uff1a<code>~/.config/letsencrypt/cli.ini</code>\uff09\u3002 \u7531\u4e8e\u6b64\u914d\u7f6e\u6587\u4ef6\u9002\u7528\u4e8ecertbot\u7684\u6240\u6709\u8c03\u7528\uff0c\u6240\u6709\u4e0d\u80fd\u5728\u5176\u4e2d\u5217\u51fa\u57df\u540d\u3002\u5728cli.ini\u4e2d\u5217\u51fa\u57df\u540d\u53ef\u80fd\u4f1a\u963b\u6b62\u7eed\u8ba2\u5de5\u4f5c\u3002</p>"},{"location":"common/certbot/#_18","title":"\u65e5\u5fd7\u5faa\u73af","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0ccertbot\u5b58\u50a8\u72b6\u6001\u65e5\u5fd7<code>/var/log/letsencrypt</code>\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e00\u65e6\u65e5\u5fd7\u76ee\u5f55\u4e2d\u67091000\u4e2a\u65e5\u5fd7\uff0ccertbot\u5c31\u4f1a\u5f00\u59cb\u65cb\u8f6c\u65e5\u5fd7\u3002\u8fd9\u610f\u5473\u7740\u4e00\u65e6\u67091000\u4e2a\u6587\u4ef6\u5728<code>/var/log/letsencryptCertbot</code>\u4e2d\uff0c\u5c06\u5220\u9664\u6700\u65e7\u7684\u6587\u4ef6\uff0c\u4e3a\u65b0\u65e5\u5fd7\u817e\u51fa\u7a7a\u95f4\u3002\u901a\u8fc7<code>--max-log-backups</code>\u66f4\u6539\u65e5\u5fd7\u6570\u91cf\u3002</p> <p>\u5305\u62ecDebian\u548cUbuntu\u5728\u5185\u7684\u4e00\u4e9b\u53d1\u884c\u7248\u4f1a\u7981\u7528certbot\u7684\u5185\u90e8\u65e5\u5fd7\u5faa\u73af\uff0c\u4ee5\u652f\u6301\u66f4\u4f20\u7edf\u7684logrotate\u811a\u672c\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u53d1\u884c\u5305\uff0c\u5e76\u4e14\u60f3\u8981\u66f4\u6539\u65e5\u5fd7\u8f6e\u8f6c\uff0c\u8bf7\u68c0\u67e5/etc/logrotate.d/certbot\u8f6e\u64ad\u811a\u672c\u3002</p>"},{"location":"kubernetes/rancher/","title":"rancher\u90e8\u7f72","text":""},{"location":"kubernetes/rancher/#docker","title":"docker","text":""},{"location":"kubernetes/rancher/#docker_1","title":"docker\u5b89\u88c5","text":"<pre><code>sudo yum install -y yum-utils \\\n  device-mapper-persistent-data \\\n  lvm2\n\nsudo yum-config-manager \\\n    --add-repo \\\n    https://download.docker.com/linux/centos/docker-ce.repo\n\nsudo yum install docker-ce docker-ce-cli containerd.io\n\nPS:https://docs.docker.com/install/linux/docker-ce/centos/\n</code></pre>"},{"location":"kubernetes/rancher/#docker_2","title":"docker\u8c03\u4f18\u914d\u7f6e","text":"<pre><code>touch /etc/docker/daemon.json\ncat &gt; /etc/docker/daemon.json &lt;&lt;EOF\n{\n    \"oom-score-adjust\": -1000,\n    \"log-driver\": \"json-file\",\n    \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"3\"\n    },\n    \"max-concurrent-downloads\": 10,\n    \"max-concurrent-uploads\": 10,\n    \"bip\": \"169.254.123.1/24\",\n    \"registry-mirrors\": [\"https://7bezldxe.mirror.aliyuncs.com\"],\n     #\"registry-mirrors\": [\"https://mirror.ccs.tencentyun.com\"],\n    \"insecure-registries\" : [\"0.0.0.0/0\"],\n    \"storage-driver\": \"overlay2\",\n    \"storage-opts\": [\n    \"overlay2.override_kernel_check=true\"\n    ]\n}\nEOF\nsystemctl daemon-reload &amp;&amp; systemctl restart docker\n</code></pre>"},{"location":"kubernetes/rancher/#docker-compose","title":"docker-compose\u5b89\u88c5","text":"<pre><code>sudo curl -L \"https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\n\nsudo chmod +x /usr/local/bin/docker-compose\nsudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose\n\nps:https://docs.docker.com/compose/install/\n</code></pre>"},{"location":"kubernetes/rancher/#ipv4","title":"\u4fee\u6539IPV4\u8f6c\u53d1","text":"<pre><code>cat &gt;&gt; /etc/sysctl.conf&lt;&lt;EOF\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nEOF\n\n\u6216\u8005\necho  \"\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\" &gt;&gt; /etc/sysctl.conf\n\n\u6267\u884csudo sysctl -p \u7acb\u523b\u751f\u6548\u3002\n</code></pre>"},{"location":"kubernetes/rancher/#rancher_1","title":"rancher\u96c6\u7fa4\u5b89\u88c5","text":""},{"location":"kubernetes/rancher/#_1","title":"\u8f85\u52a9\u5de5\u5177\u4e0b\u8f7d","text":"<p>kubectl</p> <pre><code>wget https://www.rancher.cn/download/kubernetes/linux-amd64-v1.15.3-kubectl\nchmod +x ./linux-amd64-v1.14.1-kubectl\nsudo mv ./linux-amd64-v1.14.1-kubectl /usr/local/bin/kubectl\n</code></pre> <p>helm</p> <pre><code>wget https://www.rancher.cn/download/helm/helm-v2.14.3-linux-amd64.tar.gz\ntar -zxvf helm-v2.14.3-linux-amd64.tar.gz\nchmod +x ./linux-amd64/helm\nsudo mv ./linux-amd64/helm /usr/local/bin/helm\n</code></pre> <p>rke</p> <pre><code>rke: wget https://www.rancher.cn/download/rke/v0.2.8-rke_linux-amd64\nchmod +x ./v0.2.8-rke_linux-amd64\nsudo mv ./v0.2.8-rke_linux-amd64 /usr/local/bin/rke\n</code></pre>"},{"location":"kubernetes/rancher/#_2","title":"\u514d\u5bc6\u767b\u5f55","text":"<p>\u521b\u5efarancher\u7528\u6237\u5e76\u8bbe\u7f6e\u514d\u5bc6\u767b\u5f55</p> <pre><code>useradd -g docker rancher\nsudo passwd rancher\nsudo echo 'rancher ALL=(ALL) ALL' &gt;&gt; /etc/sudoers\n\nssh-keygen -t rsa \nssh-copy-id c47\nssh-copy-id c48\nssh-copy-id c49\n\n\u914d\u7f6eAllowTcpForwarding\u548cPermitTunnel \u4e3ayes\nsed -i 's/#AllowTcpForwarding no/AllowTcpForwarding yes/g'  /etc/ssh/sshd_config\nsed -i 's/#PermitTunnel no/PermitTunnel yes/g'  /etc/ssh/sshd_config\n</code></pre>"},{"location":"kubernetes/rancher/#rancher-clusteryml","title":"rancher-cluster.yml","text":"<pre><code>cluster_name: tqcloud\nnodes:\n  - address: 192.168.60.247\n    internal_address: 192.168.60.247\n    user: rancher\n    role: [controlplane,worker,etcd]\n  - address: 192.168.60.248\n    internal_address: 192.168.60.248\n    user: rancher\n    role: [controlplane,worker,etcd]\n  - address: 192.168.60.249\n    internal_address: 192.168.60.249\n    user: rancher\n    role: [controlplane,worker,etcd]\n\nservices:\n  etcd:\n    snapshot: true\n    creation: 6h\n    retention: 24h\n</code></pre>"},{"location":"kubernetes/rancher/#k8s","title":"\u521b\u5efak8s\u96c6\u7fa4","text":"<pre><code>\u6267\u884c\uff1arke up --config ./rancher-cluster.yml\n</code></pre>"},{"location":"kubernetes/rancher/#helm","title":"\u5b89\u88c5helm","text":"<pre><code>--kubeconfig=kube_configxxx.yml\nkubectl -n kube-system create serviceaccount tiller\nkubectl create clusterrolebinding tiller \\\n--clusterrole cluster-admin --serviceaccount=kube-system:tiller\n\nkubeconfig=xxx.yml\n\nhelm_version=`helm version |grep Client | awk -F\"\"\\\" '{print $2}'`\nhelm init --upgrade \\\n--service-account tiller --skip-refresh \\\n--tiller-image registry.cn-shanghai.aliyuncs.com/rancher/tiller:$helm_version\n\n\u67e5\u770b\u72b6\u6001\nkubectl -n kube-system  rollout status deploy/tiller-deploy\n</code></pre>"},{"location":"kubernetes/rancher/#rancher_2","title":"\u5b89\u88c5rancher","text":"<p>HA rancher</p> <pre><code>helm install rancher-stable/rancher \\\n  --name rancher \\\n  --namespace cattle-system \\\n  --set hostname=rancher.hongjinpin.com \\\n  --set ingress.tls.source=secret\n  --set replicas=1\n</code></pre> <p>\u5355\u8282\u70b9rancher</p> <pre><code>docker run -d --restart=unless-stopped \\\n-p 9000:80 -p 9443:443 \\\n-v /root/data/rancher:/var/lib/rancher \\\n-v /root/var/log/auditlog:/var/log/auditlog \\\n-e AUDIT_LEVEL=3 \\\nrancher/rancher\n</code></pre>"},{"location":"kubernetes/rancher/#k8s_1","title":"k8s\u4e00\u4e9b\u914d\u7f6e","text":""},{"location":"kubernetes/rancher/#_3","title":"\u81ea\u52a8\u8865\u5168\u547d\u4ee4","text":"<pre><code>\u7f16\u8f91.bashrc\u81ea\u52a8\u8865\u5168\u547d\u4ee4\nsource &lt;(kubectl completion bash)\n</code></pre>"},{"location":"kubernetes/rancher/#k8s_2","title":"k8s\u8282\u70b9\u6dfb\u52a0\u6c61\u70b9","text":"<pre><code>kubectl taint nodes node1 cassandra:NoSchedule\n</code></pre> <p>kubectl\u67e5\u8be2\u6c61\u70b9\u6a21\u677f</p> <pre><code>{{printf \"%-50s %-12s\\n\" \"Node\" \"Taint\"}}\n{{- range .items}}\n    {{- if $taint := (index .spec \"taints\") }}\n        {{- .metadata.name }}{{ \"\\t\" }}\n        {{- range $taint }}\n            {{- .key }}={{ .value }}:{{ .effect }}{{ \"\\t\" }}\n        {{- end }}\n        {{- \"\\n\" }}\n    {{- end}}\n{{- end}}\nkubectl get nodes -o go-template-file=\"./nodes-taints.tmpl\"\n</code></pre>"},{"location":"mac/necessary-apps/","title":"mac \u5e38\u7528\u8f6f\u4ef6","text":""},{"location":"mac/necessary-apps/#_1","title":"\u5e94\u7528\u5b89\u88c5","text":"<ul> <li>\u5fae\u4fe1 &amp; \u4f01\u4e1a\u5fae\u4fe1 &amp; QQ</li> <li>\u7f51\u6613\u6709\u9053\u8bcd\u5178 &amp; \u6709\u9053\u4e91\u7b14\u8bb0</li> <li>\u5370\u8c61\u7b14\u8bb0</li> <li>Google\u6e38\u89c8\u5668 &amp; Postman</li> <li>\u9177\u72d7\u97f3\u4e50</li> <li>\u767e\u5ea6\u7f51\u76d8</li> <li>ShadowsockesX-NG</li> <li>\u8fc5\u96f7</li> <li>Sublime Text</li> <li>Items</li> <li>Jetbrains\u4ea7\u54c1\uff08Python,Java,Golang,JS,sql...\uff09</li> <li>Docker</li> <li>Sourcetree</li> <li>Rdm(redis\u53ef\u89c6\u5316\u5de5\u5177)</li> <li>Navicat Premiunm &amp;Navicat for MongoDB</li> <li>Paragon NTFS for Mac 15</li> <li>\u5fae\u8f6foffice\u5957\u88c5</li> <li>SecureCRT(SSH)</li> <li>Transmit(SFTP)</li> <li>Beyond Compare</li> <li>SwitchHosts</li> <li>Dr.Unarchiver</li> <li>Typora</li> <li>Alfred 3</li> <li>Dash</li> <li>Folx</li> <li>Movist</li> <li>Charles</li> <li>Zoom.us</li> <li>Magnet(\u89c6\u56fe\u5206\u5272)</li> <li>TeamViewer</li> </ul>"},{"location":"mac/necessary-apps/#_2","title":"\u8f6f\u4ef6\u5b89\u88c5","text":"<ul> <li>zsh</li> <li>git</li> <li>brew</li> <li>python</li> <li>golang</li> <li>autojump</li> <li></li> </ul>"},{"location":"monitor/altermanager/","title":"altermanager","text":""},{"location":"monitor/altermanager/#start","title":"start","text":"<pre><code>docker run --name alertmanager  --user \"$(id -u)\" -d -p 9093:9093 -v /opt/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml -v /opt/alertmanager/data:/alertmanager quay.io/prometheus/alertmanager:v0.26.0\n</code></pre>"},{"location":"monitor/altermanager/#altermanageryml","title":"altermanager.yml","text":"<pre><code>route:\n  group_by: ['alertname']\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 1h\n  receiver: 'teams_normal'\n  routes:\n    - match:\n        level: high\n      receiver: 'teams'\nreceivers:\n  - name: 'teams'\n    webhook_configs:\n      - url: 'http://10.0.0.1:8090'\n  - name: 'teams_normal'\n    webhook_configs:\n      - url: 'http://10.0.0.1:8089'\ninhibit_rules:\n  - source_match:\n      severity: 'critical'\n    target_match:\n      severity: 'warning'\n    equal: ['alertname', 'dev', 'instance']\ntemplates:\n- /alertmanager/templates/*.tmpl\n</code></pre>"},{"location":"monitor/altermanager/#teams","title":"\u53d1\u751f\u544a\u8b66\u5230teams","text":"<pre><code>docker run -it -d --name prom2teams -e PROM2TEAMS_CONNECTOR=\"${CONNECTOR_URL}\" -p 8089:8089 idealista/prom2teams:4.2.1\n</code></pre>"},{"location":"monitor/exporter/","title":"exporter","text":""},{"location":"monitor/exporter/#node_export","title":"\u5b89\u88c5node_export","text":"<pre><code>curl -OL https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz\nnohup ./node_exporter &gt;node_exporter.log 1&gt;&amp;2 &amp;\n</code></pre>"},{"location":"monitor/exporter/#cadvisordocker","title":"\u5b89\u88c5cadvisor\uff08docker\u76d1\u63a7\uff09","text":"<pre><code>sudo docker run \\\n  --volume=/:/rootfs:ro \\\n  --volume=/var/run:/var/run:ro \\\n  --volume=/sys:/sys:ro \\\n  --volume=/var/lib/docker/:/var/lib/docker:ro \\\n  --volume=/dev/disk/:/dev/disk:ro \\\n  --publish=8083:8080 \\\n  --detach=true \\\n  --name=cadvisor \\\n  --privileged \\\n  --device=/dev/kmsg \\\n  --restart=unless-stopped \\\n  gcr.io/cadvisor/cadvisor:v0.47.2\n</code></pre>"},{"location":"monitor/exporter/#pg-exporter","title":"pg-exporter","text":"<pre><code>docker run -ti --rm  -p 9187:9187 -e DATA_SOURCE_NAME=postgresql://postgres:{password}}@{db}:5432/postgres?sslmode=disable quay.io/prometheuscommunity/postgres-exporter:v0.13.2\n</code></pre>"},{"location":"monitor/exporter/#kafka-exporter","title":"kafka-exporter","text":"<pre><code>docker run -ti --rm -p 9308:9308 danielqsj/kafka-exporter --kafka.server=foundation-kafka-1:9092\n===\ndashboard: 11285\n\u9700\u8981\u81ea\u5df1\u6dfb\u52a0\u4e2ainstance \u7b5b\u9009\u5668\n</code></pre>"},{"location":"monitor/exporter/#redis_exporter","title":"redis_exporter","text":"<pre><code>https://github.com/oliver006/redis_exporter\nnohup ./redis_exporter -redis.addr 172.29.2.10:7000 &amp;\ndashboard: 763\n</code></pre>"},{"location":"monitor/prometheus/","title":"prometheus","text":""},{"location":"monitor/prometheus/#prometheus","title":"\u5b89\u88c5prometheus","text":""},{"location":"monitor/prometheus/#docker","title":"docker","text":"<pre><code>docker run --name prometheus  --user \"$(id -u)\" -d -p 9090:9090 \\\n-v /opt/prometheus/rules:/etc/prometheus/rules \\\n-v /opt/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \\\n-v /opt/prometheus/data:/prometheus prom/prometheus:v2.46.0 \\\n--config.file=/etc/prometheus/prometheus.yml \\\n--storage.tsdb.path=/prometheus \\\n--web.console.libraries=/usr/share/prometheus/console_libraries \\\n--web.console.templates=/usr/share/prometheus/consoles \\\n--web.enable-lifecycle \\\n--storage.tsdb.retention.time=15d \\\n--web.enable-admin-api\n</code></pre>"},{"location":"monitor/prometheus/#_1","title":"\u4e8c\u8fdb\u5236","text":"<pre><code>curl -OL https://github.com/prometheus/prometheus/releases/download/v2.46.0/prometheus-2.46.0.linux-amd64.tar.gz\nnohup ./prometheus &gt;prometheus.log 1&gt;&amp;2 &amp;\n</code></pre>"},{"location":"monitor/prometheus/#_2","title":"\u542f\u52a8\u53c2\u6570","text":"<pre><code>h, --help\uff1a\u663e\u793a\u5e2e\u52a9\u4fe1\u606f\n\n      --version\uff1a\u663e\u793a\u7248\u672c\u4fe1\u606f\n\n      --config.file=\"prometheus.yml\"\uff1a\u542f\u52a8\u65f6\uff0c\u6307\u5b9aPrometheus\u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\u7684\u8def\u5f84\u3002  \n\n      --web.listen-address=\"0.0.0.0:9090\" \uff1a\u6307\u5b9a\u7f51\u9875\u6253\u5f00Prometheus\u7684ip\u548c\u7aef\u53e3\uff0c\u9ed8\u8ba4\u4e3a\"0.0.0.0:9090\"\u3002\n\n      --web.read-timeout=5m\uff1a\u9875\u9762\u8bfb\u53d6\u8bf7\u6c42\u6700\u5927\u8d85\u65f6\u65f6\u95f4 \u3002 \n\n      --web.max-connections=512\uff1a\u540c\u65f6\u8bbf\u95eePrometheus\u9875\u9762\u7684\u6700\u5927\u8fde\u63a5\u6570\uff0c\u9ed8\u8ba4\u4e3a512\u3002\n\n      --web.external-url=&lt;URL&gt;\uff1aPrometheus\u5bf9\u5916\u63d0\u4f9b\u7684url(eg: Prometheus\u901a\u8fc7\u53cd\u5411\u4ee3\u7406\u63d0\u4f9b\u670d\u52a1)\u3002\u7528\u4e8e\u751f\u6210\u4e00\u4e2a\u76f8\u5bf9\u548c\u7edd\u5bf9\u7684\u94fe\u63a5\u8fd4\u56de\u7ed9Prometheus\u672c\u8eab\u3002\u5982\u679c\u8fd9\u4e2aurl\u6709\u8def\u5f84\u90e8\u5206\uff0c\u5b83\u5c06\u7528\u4e8ePrometheus\u6240\u6709HTTP\u7aef\u70b9\u7684\u524d\u7f00\u3002\u5982\u679c\u7701\u7565\u4e86\uff0c\u5219\u76f8\u5173\u7684url\u7ec4\u4ef6\u5c06\u81ea\u52a8\u6d3e\u751f(If the URL has a path portion, it will be used to prefix all HTTP endpoints served by Prometheus. If omitted, relevant URL components will be derived automatically)\u3002      \n\n      --web.route-prefix=&lt;path&gt;\uff1aWeb\u7aef\u70b9\u5185\u90e8\u8def\u7531\u7684\u524d\u7f00\u3002\u9ed8\u8ba4\u8def\u5f84\uff1aweb.external-url\u3002\n\n      --web.user-assets=&lt;path&gt;\uff1a\u9759\u6001\u8d44\u6e90\u8def\u5f84\uff0c\u53ef\u4ee5\u5728/user\u4e0b\u627e\u5230\u3002\n\n      --web.enable-lifecycle\uff1a\u901a\u8fc7HTTP\u8bf7\u6c42\u542f\u7528\u5173\u95ed\u548c\u91cd\u65b0\u52a0\u8f7d\u3002\n\n      --web.enable-admin-api\uff1a\u542f\u7528\u7ba1\u7406\u63a7\u5236\u64cd\u4f5c\u7684api\u7aef\u70b9\u3002(Enables API endpoints for admin control actions)\n\n      --web.console.templates=\"consoles\"\uff1a\u5230\u63a7\u5236\u53f0\u6a21\u677f\u76ee\u5f55\u7684\u8def\u5f84\uff0c\u53ef\u4ee5\u5728consoles/\u76ee\u5f55\u4e0b\u627e\u5230\u3002\n\n      --web.console.libraries=\"console_libraries\"\uff1a\u63a7\u5236\u53f0\u5e93\u76ee\u5f55\u7684\u8def\u5f84\u3002 \n\n      --storage.tsdb.path=\"data/\"\uff1a\u5b58\u50a8\u7684\u57fa\u672c\u8def\u5f84\u3002\n\n      --storage.tsdb.min-block-duration=2h\uff1a\u5728\u6301\u4e45\u5316\u4e4b\u524d\u6570\u636e\u5757\u7684\u6700\u77ed\u4fdd\u5b58\u671f\u3002\n\n      --storage.tsdb.max-block-duration=&lt;duration&gt;\uff1a\u5728\u6301\u4e45\u5316\u4e4b\u524d\u6570\u636e\u5757\u7684\u6700\u5927\u4fdd\u5b58\u671f(\u9ed8\u8ba4\u4e3a\u4fdd\u5b58\u671f\u768410%)\u3002\n\n      --storage.tsdb.retention=15d\uff1a\u5b58\u50a8\u91c7\u6837\u7684\u4fdd\u5b58\u65f6\u95f4\u3002\n\n      --storage.tsdb.no-lockfile\uff1a\u4e0d\u5728\u6570\u636e\u76ee\u5f55\u4e2d\u521b\u5efalockfile(Do not create lockfile in data directory)\u3002\n\n      --alertmanager.notification-queue-capacity=10000\uff1a\u7b49\u5f85\u62a5\u8b66\u901a\u77e5\u961f\u5217\u7684\u5927\u5c0f\u3002\n\n      --alertmanager.timeout=10s\uff1a\u53d1\u9001\u8b66\u62a5\u5230Alertmanager\u7684\u8d85\u65f6\u65f6\u95f4\u3002\n\n      --query.lookback-delta=5m\uff1a\u5141\u8bb8\u5728\u8868\u8fbe\u5f0f\u6c42\u503c\u671f\u95f4\u68c0\u7d22\u5ea6\u91cf\u503c\u7684delta\u5dee\u503c(The delta difference allowed for retrieving metrics during expression evaluations)\u3002\n\n     --query.timeout=2m\uff1a \u4e00\u4e2a\u67e5\u8be2\u5728\u7ec8\u6b62\u4e4b\u524d\u53ef\u4ee5\u6267\u884c\u7684\u6700\u957f\u65f6\u95f4(\u5982\u679c\u8d85\u8fc72min\uff0c\u5c31\u4f1a\u81ea\u52a8kill\u6389)\u3002\n\n      --query.max-concurrency=20\uff1a\u5e76\u53d1\u6267\u884c\u7684\u6700\u5927\u67e5\u8be2\u6570\uff0c\u9ed8\u8ba4\u4e3a20\u3002\n\n      --log.level=info\uff1a \u5f00\u542f\u6253\u5370\u65e5\u5fd7\u7ea7\u522b(debug,info,warn,error,fatal)\u3002\u9ed8\u8ba4\u4e3ainfo\u3002\n\n      --query.lookback-delta=10m \n</code></pre>"},{"location":"monitor/prometheus/#prometheusyml","title":"\u914d\u7f6e\u6587\u4ef6\u53c2\u8003(prometheus.yml)","text":"<p>prometheus.yml</p> <pre><code># my global config\nglobal:\n  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.\n  # scrape_timeout is set to the global default (10s).\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n           - 10.0.0.135:9093\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n   - \"/etc/prometheus/rules/*.yml\"\n  # - \"second_rules.yml\"\n\n# A scrape configuration containing exactly one endpoint to scrape:\n# Here it's Prometheus itself.\nscrape_configs:\n  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.\n  - job_name: \"prometheus\"\n\n    # metrics_path defaults to '/metrics'\n    # scheme defaults to 'http'.\n\n    static_configs:\n      - targets: [\"localhost:9090\"]\n # \u91c7\u96c6node exporter\u76d1\u63a7\u6570\u636e\n  - job_name: 'node_exporter'\n    static_configs:\n      - targets: ['10.0.0.1:9100','10.0.0.2:9100']\n  - job_name: 'node_exporter_pm'\n    static_configs:\n      - targets: ['10.0.0.1:9100','10.0.0.2:9100']\n  - job_name: 'cadvisor'\n    static_configs:\n      - targets: ['10.0.0.1:8083','10.0.0.2:8083']\n  - job_name: 'java-app'\n    file_sd_configs:\n      - files:\n        - /etc/prometheus/targets/*.json         #\u91c7\u96c6\u6587\u4ef6\u8def\u5f84\n        refresh_interval: 1m #\u81ea\u52a8\u53d1\u73b0\u95f4\u9694\u65f6\u95f4\uff0c\u9ed8\u8ba45m\n    relabel_configs:\n      - source_labels: [__new_metrics_path]\n        separator: ;\n        regex: (.*)\n        target_label: __metrics_path__\n        replacement: $1\n        action: replace\n  - job_name: 'kafka_exporter'\n    file_sd_configs:\n      - files:\n        - /etc/prometheus/targets/kafka.json         #\u91c7\u96c6\u6587\u4ef6\u8def\u5f84\n        refresh_interval: 1m #\u81ea\u52a8\u53d1\u73b0\u95f4\u9694\u65f6\u95f4\uff0c\u9ed8\u8ba45m\n          #static_configs:\n          #- targets: ['10.0.0.1:9308']\n  - job_name: 'pg_exporter'\n    file_sd_configs:\n      - files:\n        - /etc/prometheus/targets/pg.json         #\u91c7\u96c6\u6587\u4ef6\u8def\u5f84\n        refresh_interval: 1m #\u81ea\u52a8\u53d1\u73b0\u95f4\u9694\u65f6\u95f4\uff0c\u9ed8\u8ba45m\n    #static_configs:\n    #  - targets: ['10.0.0.1:9187']      \n  - job_name: 'redis_exporter'\n    file_sd_configs:\n      - files:\n        - /etc/prometheus/targets/redis.json         #\u91c7\u96c6\u6587\u4ef6\u8def\u5f84\n        refresh_interval: 1m #\u81ea\u52a8\u53d1\u73b0\u95f4\u9694\u65f6\u95f4\uff0c\u9ed8\u8ba45m\n    #static_configs:\n    #  - targets: ['10.0.0.1:9121']\n  - job_name: 'pushgateway'\n    honor_labels: true\n    scrape_interval: 300s\n    static_configs:\n      - targets: ['10.0.0.1:9091']\n</code></pre>"},{"location":"monitor/prometheus/#ruleymldemo","title":"rule.yml(demo)","text":"<pre><code>groups:\n\n- name: NodeExporter\n\n  rules:\n\n    - alert: HostOutOfMemory\n      expr: '(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 &lt; 10) * on(instance) group_left (nodename) node_uname_info{nodename=~\".+\"}'\n      for: 2m\n      labels:\n        severity: warning\n        level: high\n      annotations:\n        summary: Host out of memory (instance {{ $labels.instance }})\n        description: \"Node memory is filling up (&lt; 10% left)\\n  VALUE = {{ $value }}\\n  LABELS = {{ $labels }}\"\n</code></pre>"},{"location":"monitor/prometheus/#grafana","title":"\u5b89\u88c5grafana","text":""},{"location":"monitor/prometheus/#docker_1","title":"docker","text":"<pre><code>docker pull grafana/grafana:10.1.0-ubuntu\n\ndocker run -d -p 3000:3000 --name=grafana \\\n  --user \"$(id -u)\" \\\n  --volume \"/opt/grafana/data:/var/lib/grafana\" \\\n  grafana/grafana:10.1.0-ubuntu\n</code></pre>"},{"location":"monitor/prometheus/#_3","title":"\u4e8c\u8fdb\u5236","text":"<pre><code># https://grafana.com/docs/grafana/latest/setup-grafana/installation/debian/\nsudo apt-get install -y apt-transport-https\nsudo apt-get install -y software-properties-common wget\nsudo wget -q -O /usr/share/keyrings/grafana.key https://apt.grafana.com/gpg.key\n\necho \"deb [signed-by=/usr/share/keyrings/grafana.key] https://apt.grafana.com stable main\" | sudo tee -a /etc/apt/sources.list.d/grafana.list\necho \"deb [signed-by=/usr/share/keyrings/grafana.key] https://apt.grafana.com beta main\" | sudo tee -a /etc/apt/sources.list.d/grafana.list\n# Updates the list of available packages\nsudo apt-get update\n# Installs the latest OSS release:\nsudo apt-get install grafana\n</code></pre>"},{"location":"monitor/prometheus/#dashboard","title":"dashboard\u6a21\u7248","text":"<pre><code># dashboard node-exporter\nhttps://grafana.com/grafana/dashboards/1860-node-exporter-full/\n\n# docker\nhttps://grafana.com/grafana/dashboards/10619-docker-host-container-overview/\nhttps://grafana.com/grafana/dashboards/11600-docker-container/\nhttps://grafana.com/grafana/dashboards/13946-docker-cadvisor/\n\n# mysql 7362\nwindos10467\n</code></pre>"},{"location":"monitor/prometheus/#pushgateway","title":"\u5b89\u88c5pushgateway","text":"<pre><code>docker run --name pushgateway -d -p 9091:9091 prom/pushgateway:v1.6.2\n</code></pre>"},{"location":"monitor/prometheus/#_4","title":"\u5176\u4ed6","text":""},{"location":"monitor/prometheus/#prometheusapi","title":"prometheus\u5e38\u89c1api","text":"<pre><code># \u5220\u9664\u67d0\u4e2a\u6807\u7b7e\u6570\u636e\ncurl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={instance=\"10.0.0.182:9100\"}'\n#\u6839\u636e\u65f6\u95f4\u5220\u9664\ncurl -X POST -g 'http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]={node_load1=\".*\"}&amp;start&lt;2020-02-01T00:00:00Z&amp;end=2020-02-04T00:00:00Z'\n</code></pre>"}]}